<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Scribblate</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <style>
      :root {
        --primary: #4169e1;
        --success: #22c55e;
        --background: #ffffff;
        --text: #333333;
        --secondary: #666666;
        --border: #e5e7eb;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto,
          sans-serif;
      }

      body {
        background: var(--background);
        min-height: 100vh;
        display: flex;
        padding: 2rem;
      }

      .container {
        max-width: 1200px;
        width: 100%;
        margin: 0 auto;
        display: flex;
        gap: 2rem;
      }

      .sidebar {
        width: 300px;
        flex-shrink: 0;
      }

      .main-content {
        flex: 1;
        background: white;
        border-radius: 12px;
        padding: 2rem;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .mood-selector {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-bottom: 2rem;
      }

      .mood-button {
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 20px;
        background: #f3f4f6;
        color: var(--secondary);
        cursor: pointer;
        font-size: 1rem;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .mood-button i {
        font-size: 0.9rem;
      }

      .mood-button.active {
        background: var(--primary);
        color: white;
      }

      .add-mood-button {
        background: transparent;
        border: 2px dashed var(--border);
        color: var(--secondary);
      }

      .prompt-banner {
        background: linear-gradient(135deg, var(--primary), #7c3aed);
        color: white;
        padding: 2rem;
        border-radius: 12px;
        margin-bottom: 2rem;
        text-align: center;
        font-size: 1.2rem;
        position: relative;
        overflow: hidden;
      }

      .prompt-banner::before {
        content: '"';
        position: absolute;
        font-size: 8rem;
        opacity: 0.1;
        top: -2rem;
        left: 1rem;
      }

      .timer {
        text-align: center;
        font-size: 3rem;
        font-weight: bold;
        margin-bottom: 2rem;
        color: var(--text);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 1rem;
      }

      .timer i {
        font-size: 2rem;
        color: var(--secondary);
      }

      .message {
        text-align: center;
        color: var(--primary);
        margin-bottom: 2rem;
        font-size: 1.1rem;
      }

      .success-message {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 1rem;
        color: var(--success);
      }

      .success-message i {
        font-size: 3rem;
        animation: checkmark 0.5s ease-in-out;
      }

      @keyframes checkmark {
        0% {
          transform: scale(0);
        }
        50% {
          transform: scale(1.2);
        }
        100% {
          transform: scale(1);
        }
      }

      .story-preview {
        background: #f8fafc;
        padding: 1.5rem;
        border-radius: 12px;
        color: var(--secondary);
        min-height: 100px;
        line-height: 1.6;
      }

      .phase-dots {
        display: flex;
        justify-content: center;
        gap: 0.5rem;
        margin-top: 2rem;
      }

      .dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: var(--border);
        transition: background-color 0.3s;
      }

      .dot.active {
        background: var(--primary);
      }

      .writing-area {
        width: 100%;
        min-height: 200px;
        padding: 1.5rem;
        border: 2px solid var(--border);
        border-radius: 12px;
        font-size: 1.1rem;
        resize: none;
        display: none;
        line-height: 1.6;
      }

      .writing-area:focus {
        outline: none;
        border-color: var(--primary);
      }

      .collaborators {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 1rem;
      }

      .collaborator {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        background: #f3f4f6;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-size: 0.9rem;
      }

      .collaborator img {
        width: 24px;
        height: 24px;
        border-radius: 50%;
      }

      .sidebar-card {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .sidebar-card h3 {
        margin-bottom: 1rem;
        color: var(--text);
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .add-prompt-button {
        background: none;
        border: none;
        color: var(--primary);
        cursor: pointer;
        font-size: 1.2rem;
      }

      .custom-prompts {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }

      .prompt-item {
        background: #f3f4f6;
        padding: 0.75rem;
        border-radius: 8px;
        font-size: 0.9rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .prompt-item button {
        background: none;
        border: none;
        color: var(--secondary);
        cursor: pointer;
        opacity: 0;
        transition: opacity 0.2s;
      }

      .prompt-item:hover button {
        opacity: 1;
      }

      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        align-items: center;
        justify-content: center;
        padding: 1rem;
      }

      .modal-content {
        background: white;
        padding: 2rem;
        border-radius: 12px;
        max-width: 500px;
        width: 100%;
      }

      .modal h2 {
        margin-bottom: 1rem;
      }

      .modal input {
        width: 100%;
        padding: 0.75rem;
        border: 2px solid var(--border);
        border-radius: 8px;
        margin-bottom: 1rem;
      }

      .modal-buttons {
        display: flex;
        gap: 1rem;
        justify-content: flex-end;
      }

      .modal-button {
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 8px;
        cursor: pointer;
      }

      .modal-button.primary {
        background: var(--primary);
        color: white;
      }

      .modal-button.secondary {
        background: #f3f4f6;
        color: var(--secondary);
      }

      .contribution {
        position: relative;
        padding: 1rem;
        border-left: 3px solid var(--primary);
        margin-bottom: 1rem;
      }

      .reactions {
        display: flex;
        gap: 0.5rem;
        margin-top: 0.5rem;
      }

      .reaction-button {
        background: none;
        border: none;
        padding: 0.25rem 0.5rem;
        border-radius: 20px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 0.25rem;
        transition: all 0.2s;
        color: var(--secondary);
      }

      .reaction-button:hover {
        background: #f3f4f6;
      }

      .reaction-button.active {
        background: var(--primary);
        color: white;
      }

      .reaction-count {
        font-size: 0.8rem;
      }

      .reaction-pop {
        animation: reactionPop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      }

      @keyframes reactionPop {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.4);
        }
        100% {
          transform: scale(1);
        }
      }

      .pulse {
        animation: pulse 2s infinite;
      }

      .success-details {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }

      @keyframes pulse {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.1);
        }
        100% {
          transform: scale(1);
        }
      }

      @media (max-width: 768px) {
        .container {
          flex-direction: column;
        }

        .sidebar {
          width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="sidebar">
        <!-- Custom Prompts Section -->
        <div class="sidebar-card">
          <h3>Custom Prompts</h3>
          <div class="custom-prompts">
            <!-- User's custom prompts will be listed here -->
          </div>
          <button class="add-prompt-button" onclick="showAddPromptModal()">
            <i class="fas fa-plus"></i>
          </button>
        </div>

        <!-- Active Writers Section -->
        <div class="sidebar-card">
          <h3>Active Writers</h3>
          <div id="activeWriters" class="collaborators">
            <!-- Active writers will be shown here -->
          </div>
        </div>

        <!-- Viewers Section -->
        <div class="sidebar-card">
          <h3>Viewers <span id="viewerCount" class="viewer-count">0</span></h3>
          <div id="activeViewers" class="collaborators">
            <!-- Viewers will be shown here -->
          </div>
        </div>
      </div>

      <div class="stories-container" style="display: none">
        <div class="stories-header">
          <h2>Completed Stories</h2>
          <div class="stories-filters">
            <select id="categoryFilter">
              <option value="all">All Categories</option>
              <option value="creative">Creative</option>
              <option value="mysterious">Mysterious</option>
              <option value="adventure">Adventure</option>
            </select>
            <select id="timeFilter">
              <option value="recent">Most Recent</option>
              <option value="popular">Most Popular</option>
            </select>
          </div>
        </div>

        <div id="storiesList" class="stories-grid">
          <!-- Stories will be populated here -->
        </div>
      </div>

      <div class="main-content">
        <div class="mood-selector">
          <button class="mood-button active" data-mood="creative">
            <i class="fas fa-lightbulb"></i>
            Creative
          </button>
          <button class="mood-button" data-mood="mysterious">
            <i class="fas fa-moon"></i>
            Mysterious
          </button>
          <button class="mood-button" data-mood="adventure">
            <i class="fas fa-mountain"></i>
            Adventure
          </button>
          <button class="mood-button" data-mood="romantic">
            <i class="fas fa-heart"></i>
            Romantic
          </button>
          <button class="mood-button" data-mood="sci-fi">
            <i class="fas fa-robot"></i>
            Sci-Fi
          </button>
          <button
            class="mood-button add-mood-button"
            onclick="showAddMoodModal()"
          >
            <i class="fas fa-plus"></i>
            Add Mood
          </button>
        </div>

        <div class="prompt-banner">Loading prompt...</div>

        <div class="timer">
          <i class="far fa-clock"></i>
          <span id="timerDisplay">45</span>
        </div>

        <div class="message">Take a moment to gather your thoughts...</div>

        <!-- Add this right after the message div -->
        <div class="brainstorm-content fade show">
          <div class="story-preview">
            <!-- Story preview will appear here -->
          </div>
        </div>

        <textarea
          class="writing-area"
          placeholder="Let your creativity flow..."
        ></textarea>

        <div class="wait-message fade" style="display: none">
          <div class="success-message">
            <i class="fas fa-check-circle pulse"></i>
            <span>Great job! Your contribution has been added.</span>
          </div>
        </div>

        <div class="phase-dots">
          <div class="dot active"></div>
          <div class="dot"></div>
          <div class="dot"></div>
        </div>
      </div>
    </div>

    <!-- Add Prompt Modal -->
    <div id="addPromptModal" class="modal">
      <div class="modal-content">
        <h2>Add Custom Prompt</h2>
        <input
          type="text"
          id="newPromptInput"
          placeholder="Enter your prompt..."
        />
        <div class="modal-buttons">
          <button
            class="modal-button secondary"
            onclick="closeModal('addPromptModal')"
          >
            Cancel
          </button>
          <button class="modal-button primary" onclick="saveCustomPrompt()">
            Add Prompt
          </button>
        </div>
      </div>
    </div>

    <!-- Add Mood Modal -->
    <div id="addMoodModal" class="modal">
      <div class="modal-content">
        <h2>Add Custom Mood</h2>
        <input type="text" id="newMoodInput" placeholder="Enter mood name..." />
        <div class="modal-buttons">
          <button
            class="modal-button secondary"
            onclick="closeModal('addMoodModal')"
          >
            Cancel
          </button>
          <button class="modal-button primary" onclick="saveCustomMood()">
            Add Mood
          </button>
        </div>
      </div>
    </div>
    <script type="module">
      import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
      import {
        getAuth,
        onAuthStateChanged,
      } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
      import {
        getDatabase,
        ref,
        push,
        set,
        onValue,
        get,
        remove,
        onDisconnect,
      } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js';

      // Firebase configuration
      const firebaseConfig = {
        apiKey: 'AIzaSyD5cPsewQLJEqkzxqSGX-QZQmrK-dxpvaM',
        authDomain: 'scribblate-ce00a.firebaseapp.com',
        projectId: 'scribblate-ce00a',
        storageBucket: 'scribblate-ce00a.firebasestorage.app',
        messagingSenderId: '752237311953',
        appId: '1:752237311953:web:5d9425779169a9b80752f0',
        measurementId: 'G-B47QVGX24Y',
        databaseURL: 'https://scribblate-ce00a-default-rtdb.firebaseio.com',
      };

      // At the top of your script, right after Firebase config
      // At the top of your script
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const database = getDatabase(app);

      try {
        console.log('Firebase initialized successfully');
      } catch (error) {
        console.error('Firebase initialization error:', error);
      }

      // App state
      let currentUser = null;
      let currentStoryId = null;
      let currentPhase = 'brainstorm';
      let timeLeft = 45;
      let timer;
      let currentMood = 'creative';

      // Default prompts
      const defaultPrompts = {
        creative: [
          'In a world where shadows could speak...',
          'The old typewriter began typing by itself...',
          'When the colors started fading from the world...',
        ],
        mysterious: [
          'The letter arrived exactly one year after...',
          'The footprints in the snow led nowhere...',
          'Every night at midnight, the painting changed...',
        ],
        adventure: [
          "The map showed a location that shouldn't exist...",
          'Through the mist, a strange ship appeared...',
          'The ancient door had five different keyholes...',
        ],
        romantic: [
          'Their letters crossed in the mail...',
          'The music box played a forgotten melody...',
          'Two umbrellas collided on a rainy day...',
        ],
        'sci-fi': [
          'The android discovered it could dream...',
          'Time began flowing backwards at midnight...',
          'The stars started disappearing one by one...',
        ],
      };

      // Check authentication
      // Upate the auth state observer
      onAuthStateChanged(
        auth,
        (user) => {
          console.log(
            'Auth state changed:',
            user ? 'User logged in' : 'No user'
          );
          if (user) {
            console.log('User details:', {
              uid: user.uid,
              email: user.email,
              displayName: user.displayName,
            });
            currentUser = user;
            initializeAppFeatures(); // This will now only run after authentication
          } else {
            console.log('Redirecting to login page');
            window.location.href = 'index.html';
          }
        },
        (error) => {
          console.error('Auth state error:', error);
        }
      );

      // Initialize app
      // Update initializeAppFeatures
      let isInitialized = false;

      async function initializeAppFeatures() {
    if (isInitialized) return;

    try {
        if (!currentUser) {
            throw new Error('User not authenticated');
        }

        // Test database access
        const testRef = ref(database, `users/${currentUser.uid}/test`);
        try {
            await set(testRef, { timestamp: Date.now() });
            await remove(testRef);
            console.log('Database access verified');
        } catch (error) {
            console.error('Database access error:', error);
            throw new Error('Database access denied');
        }

        // Initialize features
        await loadUserCustomContent();
        setupMoodButtons();
        setupCustomPrompts();

        // Get story information from localStorage
        const savedStoryId = localStorage.getItem('storyId');
        const isNewStory = localStorage.getItem('isNewStory') === 'true';
        
        // Clear localStorage
        localStorage.removeItem('storyId');
        localStorage.removeItem('isNewStory');

        // Initialize story flow
        if (isNewStory) {
            await createNewStory();
        } else if (savedStoryId) {
            await joinExistingStory(savedStoryId);
        } else {
            // Default to creating new story if no context
            await createNewStory();
        }

        isInitialized = true;
        console.log('App initialization complete');

    } catch (error) {
        console.error('Error initializing app:', error);
        const message = document.querySelector('.message');
        message.innerHTML = `
            <div class="error-message">
                <i class="fas fa-exclamation-circle"></i>
                <span>There was an error initializing the app. Please try again.</span>
            </div>
        `;
    }
}

      // Load user's custom content
      async function loadUserCustomContent() {
        const customPromptsRef = ref(
          database,
          `users/${currentUser.uid}/customPrompts`
        );
        const customMoodsRef = ref(
          database,
          `users/${currentUser.uid}/customMoods`
        );

        // Load custom prompts
        onValue(customPromptsRef, (snapshot) => {
          const prompts = snapshot.val() || {};
          updateCustomPromptsUI(prompts);
        });

        // Load custom moods
        onValue(customMoodsRef, (snapshot) => {
          const moods = snapshot.val() || {};
          updateCustomMoodsUI(moods);
        });
      }

      // Story Management
      async function joinOrCreateStory() {
        const storiesRef = ref(database, 'stories');
        const activeStoriesRef = ref(database, 'activeStories');

        // Try to join an active story
        const activeStoriesSnapshot = await get(activeStoriesRef);
        if (activeStoriesSnapshot.exists()) {
          const activeStories = activeStoriesSnapshot.val();
          currentStoryId = Object.keys(activeStories)[0];
        } else {
          // Create new story
          const newStoryRef = push(storiesRef);
          currentStoryId = newStoryRef.key;
          await set(newStoryRef, {
            status: 'active',
            startedAt: Date.now(),
            contributions: [],
            participants: {
              [currentUser.uid]: {
                displayName: currentUser.displayName,
                photoURL: currentUser.photoURL,
                joinedAt: Date.now(),
              },
            },
          });

          // Mark as active
          await set(ref(database, `activeStories/${currentStoryId}`), true);
        }

        // Listen for story updates
        listenToStoryUpdates();
      }

      function updateStoryPreview(contributions) {
        const preview = document.querySelector('.story-preview');
        preview.innerHTML = Object.entries(contributions)
          .map(
            ([id, contribution]) => `
        <div class="contribution">
            <div class="contribution-header">
                <span class="contribution-author">${
                  contribution.userName
                }</span>
                <span class="contribution-time">${formatTime(
                  contribution.timestamp
                )}</span>
            </div>
            <p>${contribution.content}</p>
            <div class="reactions">
                <button class="reaction-button" onclick="addReaction('${id}', 'heart')">
                    <i class="fas fa-heart"></i>
                    <span class="reaction-count">${getReactionCount(
                      contribution,
                      'heart'
                    )}</span>
                </button>
                <button class="reaction-button" onclick="addReaction('${id}', 'laugh')">
                    <i class="fas fa-laugh"></i>
                    <span class="reaction-count">${getReactionCount(
                      contribution,
                      'laugh'
                    )}</span>
                </button>
                <button class="reaction-button" onclick="addReaction('${id}', 'wow')">
                    <i class="fas fa-surprise"></i>
                    <span class="reaction-count">${getReactionCount(
                      contribution,
                      'wow'
                    )}</span>
                </button>
                <button class="reaction-button" onclick="addReaction('${id}', 'sad')">
                    <i class="fas fa-sad-tear"></i>
                    <span class="reaction-count">${getReactionCount(
                      contribution,
                      'sad'
                    )}</span>
                </button>
                <button class="reaction-button" onclick="addReaction('${id}', 'thumbsup')">
                    <i class="fas fa-thumbs-up"></i>
                    <span class="reaction-count">${getReactionCount(
                      contribution,
                      'thumbsup'
                    )}</span>
                </button>
            </div>
        </div>
    `
          )
          .join('');
      }

      function getReactionCount(contribution, type) {
        return contribution.reactions?.[type]?.length || 0;
      }

      // Add this to your global window functions
      window.addReaction = async (contributionId, reactionType) => {
        const reactionRef = ref(
          database,
          `stories/${currentStoryId}/contributions/${contributionId}/reactions/${reactionType}`
        );
        const snapshot = await get(reactionRef);
        const reactions = snapshot.val() || [];

        const userIndex = reactions.indexOf(currentUser.uid);

        if (userIndex > -1) {
          // Remove reaction if already added
          reactions.splice(userIndex, 1);
        } else {
          // Add reaction
          reactions.push(currentUser.uid);

          // Animate the reaction button
          const button = document.querySelector(
            `[onclick="addReaction('${contributionId}', '${reactionType}')"]`
          );
          button.classList.add('reaction-pop');
          setTimeout(() => button.classList.remove('reaction-pop'), 300);
        }

        await set(reactionRef, reactions);
      };

      // Format timestamp
      function formatTime(timestamp) {
        const date = new Date(timestamp);
        const now = new Date();
        const diff = (now - date) / 1000; // difference in seconds

        if (diff < 60) return 'just now';
        if (diff < 3600) return `${Math.floor(diff / 60)}m ago`;
        if (diff < 86400) return `${Math.floor(diff / 3600)}h ago`;
        return date.toLocaleDateString();
      }

      function listenToStoryUpdates() {
        const storyRef = ref(database, `stories/${currentStoryId}`);
        onValue(storyRef, (snapshot) => {
          const story = snapshot.val();
          if (story && story.contributions) {
            const preview = Object.values(story.contributions)
              .map((c) => c.content)
              .join(' ');
            document.querySelector('.story-preview').textContent = preview;
          }

          // Update collaborators
          if (story.participants) {
            updateCollaboratorsUI(story.participants);
          }
        });
      }

      function initializeViewerTracking() {
        const viewersRef = ref(
          database,
          `stories/${currentStoryId}/viewers/${currentUser.uid}`
        );
        const disconnectRef = onDisconnect(viewersRef);

        // Remove user when they disconnect
        disconnectRef.remove();

        // Add user as viewer
        set(viewersRef, {
          displayName: currentUser.displayName,
          photoURL: currentUser.photoURL,
          lastActive: Date.now(),
          isTyping: false,
        });

        // Listen for viewer changes
        const allViewersRef = ref(
          database,
          `stories/${currentStoryId}/viewers`
        );
        onValue(allViewersRef, (snapshot) => {
          const viewers = snapshot.val() || {};
          updateViewersUI(viewers);
        });
      }

      async function loadCompletedStories() {
        const storiesRef = ref(database, 'stories');
        const completedStoriesQuery = query(
          storiesRef,
          orderByChild('status'),
          equalTo('completed')
        );

        const snapshot = await get(completedStoriesQuery);
        const stories = snapshot.val() || {};

        const storiesList = document.getElementById('storiesList');
        storiesList.innerHTML = Object.entries(stories)
          .map(
            ([id, story]) => `
            <div class="story-card">
                <div class="story-header">
                    <h3>${story.title || 'Untitled Story'}</h3>
                    <span class="story-date">${formatDate(
                      story.completedAt
                    )}</span>
                </div>
                <div class="story-preview">
                    ${getStoryPreview(story.contributions)}
                </div>
                <div class="story-footer">
                    <span>${
                      Object.keys(story.contributions).length
                    } contributions</span>
                    <button onclick="viewFullStory('${id}')" class="view-story-btn">
                        Read More
                    </button>
                </div>
            </div>
        `
          )
          .join('');
      }

      function getStoryPreview(contributions) {
        const preview = Object.values(contributions)
          .map((c) => c.content)
          .join(' ');
        return preview.slice(0, 200) + '...';
      }

      async function viewFullStory(storyId) {
        // Show full story in a modal
        const storyRef = ref(database, `stories/${storyId}`);
        const snapshot = await get(storyRef);
        const story = snapshot.val();

        showStoryModal(story);
      }

      

      function updateViewersUI(viewers) {
        const container = document.getElementById('activeViewers');
        const viewerCount = document.getElementById('viewerCount');

        // Update count
        viewerCount.textContent = Object.keys(viewers).length;

        // Update viewer list
        container.innerHTML = Object.entries(viewers)
          .map(
            ([uid, viewer]) => `
            <div class="viewer">
                <img src="${viewer.photoURL}" alt="${viewer.displayName}">
                <span>${viewer.displayName}</span>
                ${
                  viewer.isTyping
                    ? '<span class="typing-indicator">typing...</span>'
                    : ''
                }
            </div>
        `
          )
          .join('');
      }

      function setupMoodButtons() {
        console.log('Setting up mood buttons');
        const buttons = document.querySelectorAll(
          '.mood-button:not(.add-mood-button)'
        );
        buttons.forEach((button) => {
          button.addEventListener('click', () => {
            console.log('Mood button clicked:', button.dataset.mood);
            buttons.forEach((b) => b.classList.remove('active'));
            button.classList.add('active');
            currentMood = button.dataset.mood;
            updatePrompt(currentMood);
          });
        });
      }
      const achievements = {
        firstStory: {
          id: 'firstStory',
          title: 'First Story',
          description: 'Contributed to your first story',
          icon: 'fa-book',
        },
        speedWriter: {
          id: 'speedWriter',
          title: 'Speed Writer',
          description: 'Wrote over 100 words in one session',
          icon: 'fa-bolt',
        },
        nightOwl: {
          id: 'nightOwl',
          title: 'Night Owl',
          description: 'Wrote between midnight and 4 AM',
          icon: 'fa-moon',
        },
        // Add more achievements
      };

      

      async function checkAchievements(contribution) {
        const userAchievementsRef = ref(
          database,
          `users/${currentUser.uid}/achievements`
        );
        const snapshot = await get(userAchievementsRef);
        const earnedAchievements = snapshot.val() || {};

        const wordCount = contribution.split(/\s+/).length;
        const hour = new Date().getHours();

        // Check for achievements
        if (!earnedAchievements.firstStory) {
          await unlockAchievement('firstStory');
        }

        if (wordCount > 100 && !earnedAchievements.speedWriter) {
          await unlockAchievement('speedWriter');
        }

        if (hour >= 0 && hour < 4 && !earnedAchievements.nightOwl) {
          await unlockAchievement('nightOwl');
        }
      }

      async function unlockAchievement(achievementId) {
        const achievement = achievements[achievementId];
        const userAchievementsRef = ref(
          database,
          `users/${currentUser.uid}/achievements/${achievementId}`
        );

        await set(userAchievementsRef, {
          ...achievement,
          unlockedAt: Date.now(),
        });

        showAchievementNotification(achievement);
      }

      function showAchievementNotification(achievement) {
        const notification = document.createElement('div');
        notification.className =
          'achievement-notification animate__animated animate__slideInRight';
        notification.innerHTML = `
        <i class="fas ${achievement.icon}"></i>
        <div class="achievement-details">
            <h4>${achievement.title}</h4>
            <p>${achievement.description}</p>
        </div>
    `;

        document.body.appendChild(notification);
        setTimeout(() => {
          notification.classList.replace(
            'animate__slideInRight',
            'animate__slideOutRight'
          );
          setTimeout(() => notification.remove(), 1000);
        }, 3000);
      }

      // Add these missing functions
      function setupCustomPrompts() {
        const customPrompts = currentUser.customPrompts || {};
        updateCustomPromptsUI(customPrompts);
      }

      function updatePrompt(mood) {
        const prompts = defaultPrompts[mood] || defaultPrompts.creative;
        const randomPrompt =
          prompts[Math.floor(Math.random() * prompts.length)];
        const promptBanner = document.querySelector('.prompt-banner');
        promptBanner.textContent = randomPrompt;
        console.log('Updated prompt:', randomPrompt); // Debug log
      }

      function nextPhase() {
        console.log('Moving to next phase from:', currentPhase); // Debug log
        clearInterval(timer);

        const phases = ['brainstorm', 'write', 'wait'];
        const currentIndex = phases.indexOf(currentPhase);
        currentPhase = phases[(currentIndex + 1) % phases.length];

        console.log('New phase:', currentPhase); // Debug log

        updatePhaseUI();

        if (currentPhase !== 'wait') {
          timeLeft = 45;
          startTimer();
        }
      }

      function updatePhaseUI() {
        console.log('Updating phase UI:', currentPhase); // Debug log

        const elements = {
          brainstorm: document.querySelector('.brainstorm-content'),
          writing: document.querySelector('.writing-area'),
          wait: document.querySelector('.wait-message'),
          preview: document.querySelector('.story-preview'),
          message: document.querySelector('.message'),
        };

        // Hide all elements first
        elements.brainstorm.style.display = 'none';
        elements.writing.style.display = 'none';
        elements.wait.style.display = 'none';

        // Show current phase element
        switch (currentPhase) {
          case 'brainstorm':
            elements.brainstorm.style.display = 'block';
            elements.message.textContent =
              'Take a moment to gather your thoughts...';
            updatePrompt(currentMood);
            break;
          case 'write':
            elements.writing.style.display = 'block';
            elements.writing.focus();
            elements.message.textContent = 'Start writing...';
            break;
          case 'wait':
            elements.wait.style.display = 'block';
            elements.message.style.display = 'none';
            setTimeout(() => startNewStory(), 3000);
            break;
        }

        // Update dots
        const dots = document.querySelectorAll('.dot');
        dots.forEach((dot, index) => {
          dot.classList.toggle(
            'active',
            index === ['brainstorm', 'write', 'wait'].indexOf(currentPhase)
          );
        });
      }

      // Real-time collaboration
      function initializeCollaboration() {
        const presenceRef = ref(database, '.info/connected');
        onValue(presenceRef, (snapshot) => {
          if (snapshot.val()) {
            const userPresenceRef = ref(
              database,
              `stories/${currentStoryId}/participants/${currentUser.uid}`
            );

            // When I disconnect, remove me
            const disconnectRef = onDisconnect(userPresenceRef);
            disconnectRef.remove();

            // Add me to participants
            set(userPresenceRef, {
              displayName: currentUser.displayName,
              photoURL: currentUser.photoURL,
              lastActive: Date.now(),
            });

            // Rest of the code remains the same...
          }
        });
      }

      function updateTypingIndicators(typing) {
        const container = document.getElementById('typingIndicators');
        const typingUsers = Object.values(typing).filter(
          (user) => user.displayName !== currentUser.displayName
        );

        if (typingUsers.length > 0) {
          container.textContent = `${typingUsers
            .map((u) => u.displayName)
            .join(', ')} ${
            typingUsers.length === 1 ? 'is' : 'are'
          } thinking...`;
          container.style.display = 'block';
        } else {
          container.style.display = 'none';
        }
      }

      function updateCollaboratorsUI(participants) {
        const container = document.getElementById('activeWriters');
        container.innerHTML = Object.entries(participants)
          .map(
            ([uid, user]) => `
                <div class="collaborator">
                    <img src="${user.photoURL}" alt="${user.displayName}">
                    <span>${user.displayName}</span>
                </div>
            `
          )
          .join('');
      }

      // Custom Prompts Management
      async function saveCustomPrompt() {
        const promptInput = document.getElementById('newPromptInput');
        const prompt = promptInput.value.trim();

        if (prompt) {
          const promptRef = ref(
            database,
            `users/${currentUser.uid}/customPrompts`
          );
          const newPromptRef = push(promptRef);
          await set(newPromptRef, {
            text: prompt,
            createdAt: Date.now(),
          });

          promptInput.value = '';
          closeModal('addPromptModal');
        }
      }

      function updateCustomPromptsUI(prompts) {
        const container = document.querySelector('.custom-prompts');
        container.innerHTML = Object.entries(prompts)
          .map(
            ([id, prompt]) => `
                <div class="prompt-item">
                    <span>${prompt.text}</span>
                    <button onclick="deleteCustomPrompt('${id}')">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `
          )
          .join('');
      }

      // Custom Moods Management
      async function saveCustomMood() {
        const moodInput = document.getElementById('newMoodInput');
        const mood = moodInput.value.trim();

        if (mood) {
          const moodRef = ref(database, `users/${currentUser.uid}/customMoods`);
          const newMoodRef = push(moodRef);
          await set(newMoodRef, {
            name: mood,
            createdAt: Date.now(),
          });

          moodInput.value = '';
          closeModal('addMoodModal');
        }
      }

      function updateCustomMoodsUI(moods) {
        const container = document.querySelector('.mood-selector');
        const addButton = container.querySelector('.add-mood-button');

        // Remove old custom moods
        document
          .querySelectorAll('.mood-button.custom')
          .forEach((btn) => btn.remove());

        // Add new custom moods before the add button
        Object.entries(moods).forEach(([id, mood]) => {
          const button = document.createElement('button');
          button.className = 'mood-button custom';
          button.innerHTML = `
                <i class="fas fa-star"></i>
                ${mood.name}
            `;
          container.insertBefore(button, addButton);
        });
      }

      // Timer and Phase Management
      

      // First, add this CSS to your existing styles
const postContributionStyles = `
  .post-contribution {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: var(--background);
    z-index: 1000;
    display: none;
    animation: slideIn 0.3s ease-out;
  }

  .post-contribution.show {
    display: flex;
    flex-direction: column;
  }

  @keyframes slideIn {
    from {
      transform: translateY(20px);
      opacity: 0;
    }
    to {
      transform: translateY(0);
      opacity: 1;
    }
  }

  .post-contribution-header {
    padding: 2rem;
    text-align: center;
    background: var(--card-bg);
    box-shadow: var(--card-shadow);
  }

  .post-contribution-title {
    font-size: 1.5rem;
    color: var(--text);
    margin-bottom: 1rem;
  }

  .post-contribution-subtitle {
    color: var(--secondary);
    margin-bottom: 2rem;
  }

  .post-contribution-content {
    flex: 1;
    padding: 2rem;
    overflow-y: auto;
  }

  .full-story {
    max-width: 800px;
    margin: 0 auto;
    background: var(--card-bg);
    padding: 2rem;
    border-radius: 12px;
    box-shadow: var(--card-shadow);
  }

  .contribution-highlight {
    border-left: 4px solid var(--primary);
    padding-left: 1rem;
    margin: 1rem 0;
    background: rgba(65, 105, 225, 0.05);
    animation: highlight 1s ease-out;
  }

  @keyframes highlight {
    from {
      background-color: rgba(65, 105, 225, 0.2);
    }
    to {
      background-color: rgba(65, 105, 225, 0.05);
    }
  }

  .post-contribution-actions {
    display: flex;
    justify-content: center;
    gap: 1rem;
    padding: 2rem;
    background: var(--card-bg);
    box-shadow: var(--card-shadow);
  }

  .contribution-meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
    font-size: 0.9rem;
    color: var(--secondary);
  }

  .author-info {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .author-avatar {
    width: 24px;
    height: 24px;
    border-radius: 50%;
  }
`;

// Add the HTML structure to your page
const postContributionHTML = `
  <div class="post-contribution">
    <div class="post-contribution-header">
      <h2 class="post-contribution-title">Story Updated!</h2>
      <p class="post-contribution-subtitle">Your contribution has been added to the story</p>
    </div>
    
    <div class="post-contribution-content">
      <div class="full-story">
        <!-- Story content will be inserted here -->
      </div>
    </div>

    <div class="post-contribution-actions">
      <button class="button button-primary" onclick="continueCollaborating()">
        <i class="fas fa-pen"></i>
        Continue Collaborating
      </button>
      <button class="button button-secondary" onclick="startNewStory()">
        <i class="fas fa-plus"></i>
        Start New Story
      </button>
    </div>
  </div>
`;

// Add this to your JavaScript
class PostContributionHandler {
    constructor() {
        this.setupUI();
    }

    setupUI() {
        // Add styles
        const style = document.createElement('style');
        style.textContent = postContributionStyles;
        document.head.appendChild(style);

        // Add HTML
        document.body.insertAdjacentHTML('beforeend', postContributionHTML);

        // Initialize container
        this.container = document.querySelector('.post-contribution');
        this.storyContainer = this.container.querySelector('.full-story');
    }

    async showPostContribution(contributionId) {
        try {
            // Get the full story
            const storyRef = ref(database, `stories/${currentStoryId}`);
            const snapshot = await get(storyRef);
            const story = snapshot.val();

            if (!story) return;

            // Render the full story with the new contribution highlighted
            this.renderStory(story, contributionId);
            
            // Show the post-contribution screen
            this.container.classList.add('show');

            // Track story view
            this.trackStoryView();
        } catch (error) {
            console.error('Error showing post-contribution:', error);
        }
    }

    renderStory(story, highlightedContributionId) {
        const contributions = story.contributions || {};
        const sortedContributions = Object.entries(contributions)
            .sort(([, a], [, b]) => a.timestamp - b.timestamp);

        this.storyContainer.innerHTML = sortedContributions
            .map(([id, contribution]) => `
                <div class="contribution ${id === highlightedContributionId ? 'contribution-highlight' : ''}">
                    <div class="contribution-meta">
                        <div class="author-info">
                            <img src="${contribution.userPhoto || getUserPhoto(contribution.userId)}" 
                                 alt="${contribution.userName}"
                                 class="author-avatar">
                            <span>${contribution.userName}</span>
                        </div>
                        <span>${formatTime(contribution.timestamp)}</span>
                    </div>
                    <p>${contribution.content}</p>
                    <div class="reactions">
                        ${this.renderReactions(contribution.reactions || {}, id)}
                    </div>
                </div>
            `).join('');
    }

    renderReactions(reactions, contributionId) {
        const reactionTypes = {
            heart: { icon: 'fa-heart', label: 'Love' },
            laugh: { icon: 'fa-laugh', label: 'Haha' },
            wow: { icon: 'fa-surprise', label: 'Wow' },
            sad: { icon: 'fa-sad-tear', label: 'Sad' },
            thumbsup: { icon: 'fa-thumbs-up', label: 'Like' }
        };

        return Object.entries(reactionTypes)
            .map(([type, { icon, label }]) => {
                const count = (reactions[type] || []).length;
                const hasReacted = reactions[type]?.includes(currentUser.uid);
                return `
                    <button class="reaction-button ${hasReacted ? 'active' : ''}"
                            onclick="addReaction('${contributionId}', '${type}')">
                        <i class="fas ${icon}"></i>
                        <span class="reaction-count">${count}</span>
                    </button>
                `;
            }).join('');
    }

    async trackStoryView() {
        if (!currentUser) return;

        const viewRef = ref(database, `stories/${currentStoryId}/views/${currentUser.uid}`);
        await set(viewRef, {
            timestamp: Date.now(),
            userId: currentUser.uid,
            userName: currentUser.displayName
        });
    }

    hide() {
        this.container.classList.remove('show');
    }
}

// Update your submitContribution function


// Add these functions to handle post-contribution actions
window.continueCollaborating = () => {
    const postContribution = document.querySelector('.post-contribution');
    postContribution.classList.remove('show');
    startNewRound();
};

class StoryFlowManager {
    constructor() {
        this.currentPhase = null;
        this.timeLeft = 45;
        this.timer = null;
        this.storyId = null;
        
        // Get story information from localStorage
        const savedStoryId = localStorage.getItem('storyId');
        this.isNewStory = localStorage.getItem('isNewStory') === 'true';
        
        // Clear localStorage
        localStorage.removeItem('storyId');
        localStorage.removeItem('isNewStory');

        // Initialize with saved story ID if exists
        this.initializeStory(savedStoryId);
    }

    async initializeStory(storyId = null) {
        if (this.isNewStory) {
            await this.createNewStory();
        } else {
            await this.joinExistingStory(storyId);
        }
    }

    async createNewStory() {
        try {
            const storiesRef = ref(database, 'stories');
            const newStoryRef = push(storiesRef);
            this.storyId = newStoryRef.key;

            const storyData = {
                createdAt: Date.now(),
                status: 'active',
                creator: {
                    uid: currentUser.uid,
                    displayName: currentUser.displayName,
                    photoURL: currentUser.photoURL
                },
                currentMood: currentMood,
                prompt: this.generatePrompt(currentMood),
                contributions: {},
                participants: {
                    [currentUser.uid]: {
                        joinedAt: Date.now(),
                        isActive: true
                    }
                }
            };

            await set(newStoryRef, storyData);
            this.startWritingPhase();

        } catch (error) {
            console.error('Error creating new story:', error);
            alert('Error creating new story. Please try again.');
        }
    }

    async joinExistingStory(storyId) {
        try {
            this.storyId = storyId;
            const storyRef = ref(database, `stories/${storyId}`);
            const snapshot = await get(storyRef);
            const story = snapshot.val();

            if (!story) throw new Error('Story not found');

            // Join as participant
            await set(ref(database, `stories/${storyId}/participants/${currentUser.uid}`), {
                joinedAt: Date.now(),
                isActive: true
            });

            // Start with preview phase
            this.startPreviewPhase(story);

        } catch (error) {
            console.error('Error joining story:', error);
            alert('Error joining story. Please try again.');
            window.location.href = '/index.html';
        }
    }

    startPreviewPhase(story) {
        this.currentPhase = 'preview';
        this.timeLeft = 45;
        clearInterval(this.timer);

        const elements = {
            preview: document.querySelector('.story-preview'),
            writingArea: document.querySelector('.writing-area'),
            message: document.querySelector('.message'),
            prompt: document.querySelector('.prompt-banner')
        };

        // Update UI
        if (elements.preview) {
            elements.preview.style.display = 'block';
            elements.preview.innerHTML = this.formatStoryContent(story);
        }
        if (elements.writingArea) {
            elements.writingArea.style.display = 'none';
        }
        if (elements.message) {
            elements.message.textContent = 'Take a moment to read the story...';
        }
        if (elements.prompt) {
            elements.prompt.textContent = story.prompt || 'Loading prompt...';
        }

        this.startTimer(() => this.startWritingPhase());
    }

    startWritingPhase() {
        this.currentPhase = 'write';
        this.timeLeft = 45;
        clearInterval(this.timer);

        const elements = {
            preview: document.querySelector('.story-preview'),
            writingArea: document.querySelector('.writing-area'),
            message: document.querySelector('.message')
        };

        // Update UI
        if (elements.preview) elements.preview.style.display = 'none';
        if (elements.writingArea) {
            elements.writingArea.style.display = 'block';
            elements.writingArea.value = ''; // Clear any previous content
            elements.writingArea.focus();
        }
        if (elements.message) {
            elements.message.textContent = "It's your turn to write!";
        }

        this.startTimer(() => this.handleTimeUp());
    }

    startTimer(callback) {
        const timerDisplay = document.getElementById('timerDisplay');
        
        this.timer = setInterval(() => {
            this.timeLeft--;
            if (timerDisplay) timerDisplay.textContent = this.timeLeft;

            if (this.timeLeft <= 0) {
                clearInterval(this.timer);
                callback();
            }
        }, 1000);

        if (timerDisplay) timerDisplay.textContent = this.timeLeft;
    }

    formatStoryContent(story) {
        const contributions = Object.entries(story.contributions || {})
            .sort(([, a], [, b]) => a.timestamp - b.timestamp);

        return `
            <div class="story-prompt">${story.prompt}</div>
            ${contributions.map(([id, contribution]) => `
                <div class="contribution">
                    <div class="contribution-meta">
                        <div class="author-info">
                            <img src="${contribution.userPhoto}" alt="${contribution.userName}" class="author-avatar">
                            <span class="author-name">${contribution.userName}</span>
                        </div>
                        <span class="timestamp">${formatTime(contribution.timestamp)}</span>
                    </div>
                    <div class="contribution-content">${contribution.content}</div>
                </div>
            `).join('')}
        `;
    }

    generatePrompt(mood) {
        const prompts = defaultPrompts[mood] || defaultPrompts.creative;
        return prompts[Math.floor(Math.random() * prompts.length)];
    }

    async handleTimeUp() {
        if (this.currentPhase === 'write') {
            await this.submitContribution();
        }
    }

    async submitContribution() {
        const writingArea = document.querySelector('.writing-area');
        if (!writingArea) return;

        const content = writingArea.value.trim();
        if (!content) return;

        try {
            const contributionRef = push(ref(database, `stories/${this.storyId}/contributions`));
            const contribution = {
                content,
                userId: currentUser.uid,
                userName: currentUser.displayName,
                userPhoto: currentUser.photoURL,
                timestamp: Date.now()
            };

            await set(contributionRef, contribution);
            
            // Show post-contribution view
            const postContributionHandler = new PostContributionHandler();
            await postContributionHandler.showPostContribution(this.storyId, contributionRef.key);

        } catch (error) {
            console.error('Error submitting contribution:', error);
            alert('Error submitting contribution. Please try again.');
        }
    }
}

window.startNewStory = async () => {
    try {
        // Leave current story
        await leaveCurrentStory();
        
        // Create or join new story
        const newStory = await createOrJoinStorySession(currentUser.uid);
        currentStoryId = newStory.id;
        
        // Reset UI
        const postContribution = document.querySelector('.post-contribution');
        postContribution.classList.remove('show');
        
        // Initialize new story
        initializeStory();
    } catch (error) {
        console.error('Error starting new story:', error);
        alert('Error starting new story. Please try again.');
    }
};

async function leaveCurrentStory() {
    if (!currentStoryId || !currentUser) return;
    
    const participantRef = ref(database, `stories/${currentStoryId}/participants/${currentUser.uid}`);
    await remove(participantRef);
}

function startTimer() {
    clearInterval(timer);
    timeLeft = 45;
    document.getElementById('timerDisplay').textContent = timeLeft;

    timer = setInterval(() => {
        timeLeft--;
        document.getElementById('timerDisplay').textContent = timeLeft;

        if (timeLeft <= 0) {
            if (currentPhase === 'write') {
                submitContribution();
            }
            nextPhase();
        }
    }, 1000);
}

function startNewRound() {
    currentPhase = 'brainstorm';
    timeLeft = 45;
    updatePhaseUI();
    startTimer();
}



      function showSuccessAnimation() {
        const message = document.querySelector('.message');
        message.innerHTML = `
        <div class="success-message animate__animated animate__bounceIn">
            <i class="fas fa-check-circle pulse"></i>
            <div class="success-details">
                <span class="animate__animated animate__fadeInUp">Great job!</span>
                <span class="animate__animated animate__fadeInUp animate__delay-1s">
                    Your contribution has been added to the story
                </span>
            </div>
        </div>
    `;
      }

      

      // Make functions available globally
      window.showAddPromptModal = () =>
        (document.getElementById('addPromptModal').style.display = 'flex');
      window.showAddMoodModal = () =>
        (document.getElementById('addMoodModal').style.display = 'flex');
      window.closeModal = (id) =>
        (document.getElementById(id).style.display = 'none');
      window.saveCustomPrompt = saveCustomPrompt;
      window.saveCustomMood = saveCustomMood;
      window.deleteCustomPrompt = async (id) => {
        await remove(
          ref(database, `users/${currentUser.uid}/customPrompts/${id}`)
        );
      };
    </script>
  </body>
</html>
