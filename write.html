<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Scribblate</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <style>
      :root {
        --primary: #4169e1;
        --success: #22c55e;
        --background: #ffffff;
        --text: #333333;
        --secondary: #666666;
        --border: #e5e7eb;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto,
          sans-serif;
      }

      body {
        background: var(--background);
        min-height: 100vh;
        display: flex;
        padding: 2rem;
      }

      .container {
        max-width: 1200px;
        width: 100%;
        margin: 0 auto;
        display: flex;
        gap: 2rem;
      }

      .sidebar {
        width: 300px;
        flex-shrink: 0;
      }

      .main-content {
        flex: 1;
        background: white;
        border-radius: 12px;
        padding: 2rem;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .mood-selector {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-bottom: 2rem;
      }

      .mood-button {
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 20px;
        background: #f3f4f6;
        color: var(--secondary);
        cursor: pointer;
        font-size: 1rem;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .mood-button i {
        font-size: 0.9rem;
      }

      .mood-button.active {
        background: var(--primary);
        color: white;
      }

      .add-mood-button {
        background: transparent;
        border: 2px dashed var(--border);
        color: var(--secondary);
      }

      .prompt-banner {
        background: linear-gradient(135deg, var(--primary), #7c3aed);
        color: white;
        padding: 2rem;
        border-radius: 12px;
        margin-bottom: 2rem;
        text-align: center;
        font-size: 1.2rem;
        position: relative;
        overflow: hidden;
      }

      .prompt-banner::before {
        content: '"';
        position: absolute;
        font-size: 8rem;
        opacity: 0.1;
        top: -2rem;
        left: 1rem;
      }

      .timer {
        text-align: center;
        font-size: 3rem;
        font-weight: bold;
        margin-bottom: 2rem;
        color: var(--text);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 1rem;
      }

      .timer i {
        font-size: 2rem;
        color: var(--secondary);
      }

      .message {
        text-align: center;
        color: var(--primary);
        margin-bottom: 2rem;
        font-size: 1.1rem;
      }

      .success-message {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 1rem;
        color: var(--success);
      }

      .success-message i {
        font-size: 3rem;
        animation: checkmark 0.5s ease-in-out;
      }

      @keyframes checkmark {
        0% {
          transform: scale(0);
        }
        50% {
          transform: scale(1.2);
        }
        100% {
          transform: scale(1);
        }
      }

      .story-preview {
        background: #f8fafc;
        padding: 1.5rem;
        border-radius: 12px;
        color: var(--secondary);
        min-height: 100px;
        line-height: 1.6;
      }

      .phase-dots {
        display: flex;
        justify-content: center;
        gap: 0.5rem;
        margin-top: 2rem;
      }

      .dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: var(--border);
        transition: background-color 0.3s;
      }

      .dot.active {
        background: var(--primary);
      }

      .writing-area {
        width: 100%;
        min-height: 200px;
        padding: 1.5rem;
        border: 2px solid var(--border);
        border-radius: 12px;
        font-size: 1.1rem;
        resize: none;
        display: none;
        line-height: 1.6;
      }

      .writing-area:focus {
        outline: none;
        border-color: var(--primary);
      }

      .collaborators {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 1rem;
      }

      .collaborator {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        background: #f3f4f6;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-size: 0.9rem;
      }

      .user-avatar, /* For any user avatars */
.author-avatar, /* For contribution author avatars */
.collaborator img, /* For active writers */
.viewer img { /* For viewers */
    width: 32px;
    height: 32px;
    border-radius: 50%;
    object-fit: cover; /* This ensures the image maintains aspect ratio */
}

.contribution .author-avatar {
    width: 24px;
    height: 24px;
}

      .sidebar-card {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .sidebar-card h3 {
        margin-bottom: 1rem;
        color: var(--text);
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .add-prompt-button {
        background: none;
        border: none;
        color: var(--primary);
        cursor: pointer;
        font-size: 1.2rem;
      }

      .custom-prompts {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }

      .prompt-item {
        background: #f3f4f6;
        padding: 0.75rem;
        border-radius: 8px;
        font-size: 0.9rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .prompt-item button {
        background: none;
        border: none;
        color: var(--secondary);
        cursor: pointer;
        opacity: 0;
        transition: opacity 0.2s;
      }

      .prompt-item:hover button {
        opacity: 1;
      }

      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        align-items: center;
        justify-content: center;
        padding: 1rem;
      }

      .modal-content {
        background: white;
        padding: 2rem;
        border-radius: 12px;
        max-width: 500px;
        width: 100%;
      }

      .modal h2 {
        margin-bottom: 1rem;
      }

      .modal input {
        width: 100%;
        padding: 0.75rem;
        border: 2px solid var(--border);
        border-radius: 8px;
        margin-bottom: 1rem;
      }

      .author-info {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

      .modal-buttons {
        display: flex;
        gap: 1rem;
        justify-content: flex-end;
      }

      .modal-button {
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 8px;
        cursor: pointer;
      }

      .modal-button.primary {
        background: var(--primary);
        color: white;
      }

      .modal-button.secondary {
        background: #f3f4f6;
        color: var(--secondary);
      }

      .contribution {
    border-left: 3px solid var(--primary);
    padding: 1rem;
    margin-bottom: 1rem;
    background: white;
    border-radius: 0 8px 8px 0;
}

contribution-meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
    font-size: 0.9rem;
    color: var(--secondary);
}

      .reactions {
        display: flex;
        gap: 0.5rem;
        margin-top: 0.5rem;
      }

      

      .reaction-button {
        background: none;
        border: none;
        padding: 0.25rem 0.5rem;
        border-radius: 20px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 0.25rem;
        transition: all 0.2s;
        color: var(--secondary);
      }

      .reaction-button:hover {
        background: #f3f4f6;
      }

      .reaction-button.active {
        background: var(--primary);
        color: white;
      }

      .reaction-count {
        font-size: 0.8rem;
      }

      .reaction-pop {
        animation: reactionPop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      }

      @keyframes reactionPop {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.4);
        }
        100% {
          transform: scale(1);
        }
      }

      .pulse {
        animation: pulse 2s infinite;
      }

      .success-details {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }

      @keyframes pulse {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.1);
        }
        100% {
          transform: scale(1);
        }
      }

      @media (max-width: 768px) {
        .container {
          flex-direction: column;
        }

        .sidebar {
          width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="sidebar">
        <!-- Custom Prompts Section -->
        <div class="sidebar-card">
          <h3>Custom Prompts</h3>
          <div class="custom-prompts">
            <!-- User's custom prompts will be listed here -->
          </div>
          <button class="add-prompt-button" onclick="showAddPromptModal()">
            <i class="fas fa-plus"></i>
          </button>
        </div>

        <!-- Active Writers Section -->
        <div class="sidebar-card">
          <h3>Active Writers</h3>
          <div id="activeWriters" class="collaborators">
            <!-- Active writers will be shown here -->
          </div>
        </div>

        <!-- Viewers Section -->
        <div class="sidebar-card">
          <h3>Viewers <span id="viewerCount" class="viewer-count">0</span></h3>
          <div id="activeViewers" class="collaborators">
            <!-- Viewers will be shown here -->
          </div>
        </div>
      </div>

      <div class="stories-container" style="display: none">
        <div class="stories-header">
          <h2>Completed Stories</h2>
          <div class="stories-filters">
            <select id="categoryFilter">
              <option value="all">All Categories</option>
              <option value="creative">Creative</option>
              <option value="mysterious">Mysterious</option>
              <option value="adventure">Adventure</option>
            </select>
            <select id="timeFilter">
              <option value="recent">Most Recent</option>
              <option value="popular">Most Popular</option>
            </select>
          </div>
        </div>

        <div id="storiesList" class="stories-grid">
          <!-- Stories will be populated here -->
        </div>
      </div>

      <div class="main-content">
        <div class="mood-selector">
          <button class="mood-button active" data-mood="creative">
            <i class="fas fa-lightbulb"></i>
            Creative
          </button>
          <button class="mood-button" data-mood="mysterious">
            <i class="fas fa-moon"></i>
            Mysterious
          </button>
          <button class="mood-button" data-mood="adventure">
            <i class="fas fa-mountain"></i>
            Adventure
          </button>
          <button class="mood-button" data-mood="romantic">
            <i class="fas fa-heart"></i>
            Romantic
          </button>
          <button class="mood-button" data-mood="sci-fi">
            <i class="fas fa-robot"></i>
            Sci-Fi
          </button>
          <button
            class="mood-button add-mood-button"
            onclick="showAddMoodModal()"
          >
            <i class="fas fa-plus"></i>
            Add Mood
          </button>
        </div>

        <div class="prompt-banner">Loading prompt...</div>

        <div class="timer">
          <i class="far fa-clock"></i>
          <span id="timerDisplay">45</span>
        </div>

        <div class="message">Take a moment to gather your thoughts...</div>

        <!-- Add this right after the message div -->
        <div class="brainstorm-content fade show">
          <div class="story-preview">
            <!-- Story preview will appear here -->
          </div>
        </div>

        <textarea
          class="writing-area"
          placeholder="Let your creativity flow..."
        ></textarea>

        <div class="wait-message fade" style="display: none">
          <div class="success-message">
            <i class="fas fa-check-circle pulse"></i>
            <span>Great job! Your contribution has been added.</span>
          </div>
        </div>

        <div class="phase-dots">
          <div class="dot active"></div>
          <div class="dot"></div>
          <div class="dot"></div>
        </div>
      </div>
    </div>

    <!-- Add Prompt Modal -->
    <div id="addPromptModal" class="modal">
      <div class="modal-content">
        <h2>Add Custom Prompt</h2>
        <input
          type="text"
          id="newPromptInput"
          placeholder="Enter your prompt..."
        />
        <div class="modal-buttons">
          <button
            class="modal-button secondary"
            onclick="closeModal('addPromptModal')"
          >
            Cancel
          </button>
          <button class="modal-button primary" onclick="saveCustomPrompt()">
            Add Prompt
          </button>
        </div>
      </div>
    </div>

    <!-- Add Mood Modal -->
    <div id="addMoodModal" class="modal">
      <div class="modal-content">
        <h2>Add Custom Mood</h2>
        <input type="text" id="newMoodInput" placeholder="Enter mood name..." />
        <div class="modal-buttons">
          <button
            class="modal-button secondary"
            onclick="closeModal('addMoodModal')"
          >
            Cancel
          </button>
          <button class="modal-button primary" onclick="saveCustomMood()">
            Add Mood
          </button>
        </div>
      </div>
    </div>
    <script type="module">
      
      import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
      import {
        getAuth,
        onAuthStateChanged,
      } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
      import {
        getDatabase,
        ref,
        push,
        set,
        onValue,
        get,
        remove,
        onDisconnect,
      } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js';

      // Firebase configuration
      const firebaseConfig = {
        apiKey: 'AIzaSyD5cPsewQLJEqkzxqSGX-QZQmrK-dxpvaM',
        authDomain: 'scribblate-ce00a.firebaseapp.com',
        projectId: 'scribblate-ce00a',
        storageBucket: 'scribblate-ce00a.firebasestorage.app',
        messagingSenderId: '752237311953',
        appId: '1:752237311953:web:5d9425779169a9b80752f0',
        measurementId: 'G-B47QVGX24Y',
        databaseURL: 'https://scribblate-ce00a-default-rtdb.firebaseio.com',
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const database = getDatabase(app);

      // App state
      let currentUser = null;
      let currentStoryId = null;
      let currentPhase = 'brainstorm';
      let timeLeft = 45;
      let timer;
      let currentMood = 'creative';
      let isInitialized = false;

      // Default prompts
      const defaultPrompts = {
        creative: [
          'In a world where shadows could speak...',
          'The old typewriter began typing by itself...',
          'When the colors started fading from the world...',
        ],
        mysterious: [
          'The letter arrived exactly one year after...',
          'The footprints in the snow led nowhere...',
          'Every night at midnight, the painting changed...',
        ],
        adventure: [
          "The map showed a location that shouldn't exist...",
          'Through the mist, a strange ship appeared...',
          'The ancient door had five different keyholes...',
        ],
        romantic: [
          'Their letters crossed in the mail...',
          'The music box played a forgotten melody...',
          'Two umbrellas collided on a rainy day...',
        ],
        'sci-fi': [
          'The android discovered it could dream...',
          'Time began flowing backwards at midnight...',
          'The stars started disappearing one by one...',
        ],
      };

      // Achievements system
      const achievements = {
        firstStory: {
          id: 'firstStory',
          title: 'First Story',
          description: 'Contributed to your first story',
          icon: 'fa-book',
        },
        speedWriter: {
          id: 'speedWriter',
          title: 'Speed Writer',
          description: 'Wrote over 100 words in one session',
          icon: 'fa-bolt',
        },
        nightOwl: {
          id: 'nightOwl',
          title: 'Night Owl',
          description: 'Wrote between midnight and 4 AM',
          icon: 'fa-moon',
        },
      };

      // Utility Functions
      function formatTime(timestamp) {
        const date = new Date(timestamp);
        const now = new Date();
        const diff = (now - date) / 1000;

        if (diff < 60) return 'just now';
        if (diff < 3600) return `${Math.floor(diff / 60)}m ago`;
        if (diff < 86400) return `${Math.floor(diff / 3600)}h ago`;
        return date.toLocaleDateString();
      }

      function getStoryPreview(contributions) {
        if (!contributions) return '';
        const preview = Object.values(contributions)
          .map((c) => c.content)
          .join(' ');
        return preview.slice(0, 200) + '...';
      }

      function updatePrompt(mood) {
        const prompts = defaultPrompts[mood] || defaultPrompts.creative;
        const randomPrompt =
          prompts[Math.floor(Math.random() * prompts.length)];
        const promptBanner = document.querySelector('.prompt-banner');
        if (promptBanner) {
          promptBanner.textContent = randomPrompt;
        }
      }

      // Post contribution styles and HTML
  

      // PostContributionHandler Class
      class PostContributionHandler {
    constructor() {
        this.container = null;
        this.storyContainer = null;
        this.initialized = false;
        this.setupUI();
    }

    setupUI() {
        try {
            // Add styles if they don't exist
            if (!document.querySelector('style[data-type="post-contribution"]')) {
                const style = document.createElement('style');
                style.setAttribute('data-type', 'post-contribution');
                style.textContent = postContributionStyles;
                document.head.appendChild(style);
            }

            // Add HTML if it doesn't exist
            if (!document.querySelector('.post-contribution')) {
                document.body.insertAdjacentHTML('beforeend', postContributionHTML);
            }

            // Initialize container references
            this.container = document.querySelector('.post-contribution');
            if (this.container) {
                this.storyContainer = this.container.querySelector('.full-story');
                this.initialized = true;
            }
        } catch (error) {
            console.error('Error setting up PostContributionHandler:', error);
            this.initialized = false;
        }
    }

    async showPostContribution(contributionId) {
        if (!this.initialized) {
            this.setupUI();
            if (!this.initialized) {
                console.error('PostContributionHandler not properly initialized');
                return;
            }
        }

        try {
            const storyRef = ref(database, `stories/${currentStoryId}`);
            const snapshot = await get(storyRef);
            const story = snapshot.val();

            if (!story) return;

            this.renderStory(story, contributionId);
            this.container.classList.add('show');
            await this.trackStoryView();
        } catch (error) {
            console.error('Error showing post-contribution:', error);
        }
    }

    renderStory(story, highlightedContributionId) {
        if (!this.storyContainer) {
            console.error('Story container not found');
            return;
        }

        const contributions = story.contributions || {};
        const sortedContributions = Object.entries(contributions)
            .sort(([, a], [, b]) => a.timestamp - b.timestamp);

        this.storyContainer.innerHTML = sortedContributions
            .map(([id, contribution]) => `
                <div class="contribution ${id === highlightedContributionId ? 'contribution-highlight' : ''}">
                    <div class="contribution-meta">
                        <div class="author-info">
                            <img src="${contribution.userPhoto}" alt="${contribution.userName}" class="author-avatar">
                            <span>${contribution.userName}</span>
                        </div>
                        <span>${formatTime(contribution.timestamp)}</span>
                    </div>
                    <p>${contribution.content}</p>
                    <div class="reactions">
                        ${this.renderReactions(contribution.reactions || {}, id)}
                    </div>
                </div>
            `).join('');
    }

    hide() {
        if (this.container) {
            this.container.classList.remove('show');
        }
    }
}

        

      // StoryFlowManager Class
      class StoryFlowManager {
    constructor() {
        this.currentPhase = null;
        this.timeLeft = 45;
        this.timer = null;
        this.storyId = null;
        // Don't create PostContributionHandler in constructor
        this.postContributionHandler = null;
    }

    async initialize() {
    try {
        this.postContributionHandler = new PostContributionHandler();
        
        const savedStoryId = localStorage.getItem('storyId');
        const isNewStory = localStorage.getItem('isNewStory') === 'true';

        localStorage.removeItem('storyId');
        localStorage.removeItem('isNewStory');

        if (savedStoryId) {
            // Joining existing story
            const story = await this.joinExistingStory(savedStoryId);
            this.storyId = savedStoryId;
            currentStoryId = this.storyId;
            
            // Start with preview phase
            await this.startPreviewPhase(story);
        } else {
            // Creating new story
            const story = await this.createNewStory();
            this.storyId = story.id;
            currentStoryId = this.storyId;
            
            // Start with brainstorm phase
            await this.startBrainstormPhase();
        }

        this.initializeCollaboration();
        this.initializeViewerTracking();
        this.setupStoryListeners();
    } catch (error) {
        console.error('Error initializing StoryFlowManager:', error);
        throw error;
    }
}

async startBrainstormPhase() {
    this.currentPhase = 'brainstorm';
    this.timeLeft = 45;
    this.clearTimer();

    const elements = this.getUIElements();

    // Hide writing area during brainstorm
    if (elements.writingArea) {
        elements.writingArea.style.display = 'none';
        elements.writingArea.value = '';
    }

    // Show preview but clear it
    if (elements.preview) {
        elements.preview.style.display = 'block';
        elements.preview.innerHTML = '';
    }

    // Update UI messages
    if (elements.message) {
        elements.message.textContent = 'Take a moment to gather your thoughts...';
    }

    if (elements.prompt) {
        const prompt = this.generatePrompt(currentMood);
        elements.prompt.textContent = prompt;
        
        // Save prompt to story
        if (this.storyId) {
            await set(ref(database, `stories/${this.storyId}/prompt`), prompt);
        }
    }

    this.startTimer(() => this.startPreviewPhase());
    this.updatePhaseIndicator('brainstorm');
}

        async createNewStory() {
          try {
            const storiesRef = ref(database, 'stories');
            const newStoryRef = push(storiesRef);

            const storyData = {
              createdAt: Date.now(),
              status: 'active',
              creator: {
                uid: currentUser.uid,
                displayName: currentUser.displayName,
                photoURL: currentUser.photoURL,
              },
              currentMood,
              prompt: this.generatePrompt(currentMood),
              contributions: {},
              participants: {
                [currentUser.uid]: {
                  joinedAt: Date.now(),
                  isActive: true,
                  displayName: currentUser.displayName,
                  photoURL: currentUser.photoURL,
                },
              },
            };

            await set(newStoryRef, storyData);
            return { id: newStoryRef.key, ...storyData };
          } catch (error) {
            console.error('Error creating new story:', error);
            throw error;
          }
        }

        async joinExistingStory(storyId) {
          try {
            const storyRef = ref(database, `stories/${storyId}`);
            const snapshot = await get(storyRef);
            const story = snapshot.val();

            if (!story) throw new Error('Story not found');

            await set(
              ref(
                database,
                `stories/${storyId}/participants/${currentUser.uid}`
              ),
              {
                joinedAt: Date.now(),
                isActive: true,
                displayName: currentUser.displayName,
                photoURL: currentUser.photoURL,
              }
            );

            return story;
          } catch (error) {
            console.error('Error joining story:', error);
            throw error;
          }
        }

        initializeCollaboration() {
  const presenceRef = ref(database, '.info/connected');
  onValue(presenceRef, (snapshot) => {
    if (snapshot.val()) {
      // Only add as participant if in writing phase
      if (this.currentPhase === 'write') {
        const userPresenceRef = ref(
          database,
          `stories/${this.storyId}/participants/${currentUser.uid}`
        );

        const disconnectRef = onDisconnect(userPresenceRef);
        disconnectRef.remove();

        set(userPresenceRef, {
          displayName: currentUser.displayName,
          photoURL: currentUser.photoURL,
          lastActive: Date.now(),
          isActive: true,
          isWriter: true
        });
      }
    }
  });

  this.setupStoryListeners();
}

setupStoryListeners() {
    if (!this.storyId) return;
    
    // Listen for story updates
    const storyRef = ref(database, `stories/${this.storyId}`);
    onValue(storyRef, (snapshot) => {
        const story = snapshot.val();
        if (story) {
            console.log('Story updated:', story);
            // Update contributions preview
            this.updateStoryPreview(story.contributions || {});
            // Update phase if necessary
            if (story.currentPhase && story.currentPhase !== this.currentPhase) {
                this.handlePhaseTransition();
            }
        }
    });
}

initializeViewerTracking() {
  // Only track as viewer if NOT in writing phase
  if (this.currentPhase !== 'write') {
    const viewersRef = ref(
      database,
      `stories/${this.storyId}/viewers/${currentUser.uid}`
    );
    const disconnectRef = onDisconnect(viewersRef);
    disconnectRef.remove();

    set(viewersRef, {
      displayName: currentUser.displayName,
      photoURL: currentUser.photoURL,
      lastActive: Date.now(),
      isTyping: false
    });
  }

  const allViewersRef = ref(database, `stories/${this.storyId}/viewers`);
  onValue(allViewersRef, (snapshot) => {
    const viewers = snapshot.val() || {};
    // Filter out current writers from viewers list
    const filteredViewers = Object.entries(viewers).reduce((acc, [uid, viewer]) => {
      if (!document.querySelector(`#activeWriters .collaborator[data-uid="${uid}"]`)) {
        acc[uid] = viewer;
      }
      return acc;
    }, {});
    updateViewersUI(filteredViewers);
  });
}

        updateStoryPreview(contributions) {
          const preview = document.querySelector('.story-preview');
          if (!preview) return;

          const sortedContributions = Object.entries(contributions).sort(
            ([, a], [, b]) => a.timestamp - b.timestamp
          );

          preview.innerHTML = sortedContributions
            .map(([id, contribution]) =>
              this.formatContribution(id, contribution)
            )
            .join('');
        }

        formatContribution(id, contribution) {
          return `
            <div class="contribution">
                <div class="contribution-meta">
                    <div class="author-info">
                        <img src="${contribution.userPhoto}" alt="${
            contribution.userName
          }" class="author-avatar">
                        <span>${contribution.userName}</span>
                    </div>
                    <span class="timestamp">${formatTime(
                      contribution.timestamp
                    )}</span>
                </div>
                <div class="contribution-content">${contribution.content}</div>
                <div class="reactions">${this.formatReactions(
                  contribution.reactions,
                  id
                )}</div>
            </div>
        `;
        }

        formatReactions(reactions = {}, contributionId) {
          const reactionTypes = {
            heart: { icon: 'fa-heart', label: 'Love' },
            laugh: { icon: 'fa-laugh', label: 'Haha' },
            wow: { icon: 'fa-surprise', label: 'Wow' },
            sad: { icon: 'fa-sad-tear', label: 'Sad' },
            thumbsup: { icon: 'fa-thumbs-up', label: 'Like' },
          };

          return Object.entries(reactionTypes)
            .map(([type, { icon }]) => {
              const count = (reactions[type] || []).length;
              const hasReacted = reactions[type]?.includes(currentUser.uid);
              return `
                    <button class="reaction-button ${
                      hasReacted ? 'active' : ''
                    }" 
                            onclick="addReaction('${contributionId}', '${type}')">
                        <i class="fas ${icon}"></i>
                        <span class="reaction-count">${count}</span>
                    </button>
                `;
            })
            .join('');
        }

        async startPreviewPhase(story) {
    this.currentPhase = 'preview';
    this.timeLeft = 45;
    this.clearTimer();

    const elements = this.getUIElements();

    // Fetch latest story data if we have an ID
    let storyData = story;
    if (this.storyId && !story) {
        const storyRef = ref(database, `stories/${this.storyId}`);
        const snapshot = await get(storyRef);
        storyData = snapshot.val();
    }

    // Show preview with story content
    if (elements.preview) {
        elements.preview.style.display = 'block';
        
        // Format story content with contributions
        const contributionsHtml = storyData?.contributions ? 
            Object.entries(storyData.contributions)
                .sort(([, a], [, b]) => a.timestamp - b.timestamp)
                .map(([id, contribution]) => `
                    <div class="contribution">
                        <div class="contribution-meta">
                            <div class="author-info">
                                <img src="${contribution.userPhoto}" alt="${contribution.userName}" class="author-avatar">
                                <span>${contribution.userName}</span>
                            </div>
                            <span class="timestamp">${formatTime(contribution.timestamp)}</span>
                        </div>
                        <div class="contribution-content">${contribution.content}</div>
                    </div>
                `).join('') : '';

        elements.preview.innerHTML = `
            <div class="story-content">
                ${storyData?.prompt ? `
                    <div class="story-prompt">
                        <strong>Prompt:</strong> ${storyData.prompt}
                    </div>
                ` : ''}
                ${contributionsHtml}
            </div>
        `;
    }

    // Hide writing area during preview
    if (elements.writingArea) {
        elements.writingArea.style.display = 'none';
    }

    // Update UI messages
    if (elements.message) {
        elements.message.textContent = 'Take a moment to read the story...';
    }

    // Update prompt banner
    if (elements.prompt && storyData?.prompt) {
        elements.prompt.textContent = storyData.prompt;
    }

    // Start timer for preview phase
    this.startTimer(); // Remove callback here
    this.updatePhaseIndicator('preview');
}

async startWritingPhase() {
    console.log('Starting writing phase');
    this.currentPhase = 'write';
    this.timeLeft = 45;
    this.clearTimer();

    const elements = this.getUIElements();

    // Hide preview, show writing area
    if (elements.preview) {
        elements.preview.style.display = 'none';
    }
    if (elements.writingArea) {
        elements.writingArea.style.display = 'block';
        elements.writingArea.value = '';
        elements.writingArea.focus();
    }

    // Update message
    if (elements.message) {
        elements.message.textContent = "It's your turn to write!";
    }

    // Start timer
    this.startTimer();
    this.updatePhaseIndicator('write');

    // Update Firebase status
    if (this.storyId) {
        await set(ref(database, `stories/${this.storyId}/currentPhase`), {
            phase: 'write',
            timestamp: serverTimestamp()
        });
    }
}

async handlePhaseTransition() {
    if (!this.currentPhase) {
        await this.startBrainstormPhase();
        return;
    }

    try {
        switch(this.currentPhase) {
            case 'brainstorm':
                console.log('Transitioning from brainstorm to preview');
                await this.startPreviewPhase();
                break;
            case 'preview':
                console.log('Transitioning from preview to write');
                await this.startWritingPhase();
                break;
            case 'write':
                console.log('Transitioning from write phase');
                await this.handleTimeUp();
                break;
            default:
                console.log('Starting new round');
                await this.startBrainstormPhase();
        }
    } catch (error) {
        console.error('Error in phase transition:', error);
        ErrorHandler.handleError(error, 'phase_transition');
    }
}

        updatePhaseIndicator(phase) {
          const dots = document.querySelectorAll('.phase-dots .dot');
          const phases = ['brainstorm', 'write', 'preview'];
          const currentIndex = phases.indexOf(phase);

          dots.forEach((dot, index) => {
            dot.classList.toggle('active', index === currentIndex);
          });
        }

        getUIElements() {
          return {
            preview: document.querySelector('.story-preview'),
            writingArea: document.querySelector('.writing-area'),
            message: document.querySelector('.message'),
            prompt: document.querySelector('.prompt-banner'),
          };
        }

        clearTimer() {
          if (this.timer) {
            clearInterval(this.timer);
            this.timer = null;
          }
        }

        startTimer(callback) {
    const timerDisplay = document.getElementById('timerDisplay');

    this.timer = setInterval(() => {
        this.timeLeft--;
        if (timerDisplay) timerDisplay.textContent = this.timeLeft;

        if (this.timeLeft <= 0) {
            this.clearTimer();
            this.handlePhaseTransition(); // Changed from callback() to this.handlePhaseTransition()
        }
    }, 1000);

    if (timerDisplay) timerDisplay.textContent = this.timeLeft;
}

        

        formatStoryContent(story) {
          return `
            <div class="story-prompt">${story.prompt}</div>
            ${Object.entries(story.contributions || {})
              .sort(([, a], [, b]) => a.timestamp - b.timestamp)
              .map(([id, contribution]) =>
                this.formatContribution(id, contribution)
              )
              .join('')}
        `;
        }

        generatePrompt(mood) {
          const prompts = defaultPrompts[mood] || defaultPrompts.creative;
          return prompts[Math.floor(Math.random() * prompts.length)];
        }

        async handleTimeUp() {
    console.log('Time is up for phase:', this.currentPhase);
    
    if (this.currentPhase === 'write') {
        await this.submitContribution();
        // After submitting, start a new round
        await this.startBrainstormPhase();
    } else if (this.currentPhase === 'preview') {
        await this.startWritingPhase();
    } else if (this.currentPhase === 'brainstorm') {
        await this.startPreviewPhase();
    }
}

async submitContribution() {
    const writingArea = document.querySelector('.writing-area');
    if (!writingArea) return;

    const content = writingArea.value.trim();
    if (!content) return;

    try {
        const contributionRef = push(ref(database, `stories/${this.storyId}/contributions`));
        const contribution = {
            content,
            userId: currentUser.uid,
            userName: currentUser.displayName,
            userPhoto: currentUser.photoURL,
            timestamp: Date.now()
        };

        await set(contributionRef, contribution);
        await checkAchievements(content);
        
        // Show success message
        const message = document.querySelector('.message');
        const waitMessage = document.querySelector('.wait-message');
        if (message) message.style.display = 'none';
        if (waitMessage) {
            waitMessage.style.display = 'flex';
            setTimeout(() => {
                waitMessage.style.display = 'none';
                if (message) message.style.display = 'block';
            }, 2000);
        }

        // Hide writing area
        writingArea.style.display = 'none';

    } catch (error) {
        console.error('Error submitting contribution:', error);
        throw error;
    }
}
      }

      // UI Functions
      async function setupCustomPrompts() {
        if (!currentUser) return;

        const promptsRef = ref(
          database,
          `users/${currentUser.uid}/customPrompts`
        );
        const snapshot = await get(promptsRef);
        const customPrompts = snapshot.val() || {};
        updateCustomPromptsUI(customPrompts);
      }

      function updateCustomPromptsUI(prompts) {
        const container = document.querySelector('.custom-prompts');
        if (!container) return;

        container.innerHTML = Object.entries(prompts)
          .map(
            ([id, prompt]) => `
            <div class="prompt-item">
                <span>${prompt.text}</span>
                <button onclick="deleteCustomPrompt('${id}')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `
          )
          .join('');
      }

      function updateCustomMoodsUI(moods) {
        const container = document.querySelector('.mood-selector');
        const addButton = container.querySelector('.add-mood-button');
        if (!container || !addButton) return;

        // Remove old custom moods
        document
          .querySelectorAll('.mood-button.custom')
          .forEach((btn) => btn.remove());

        // Add new custom moods before the add button
        Object.entries(moods).forEach(([id, mood]) => {
          const button = document.createElement('button');
          button.className = 'mood-button custom';
          button.dataset.mood = mood.name.toLowerCase();
          button.innerHTML = `
            <i class="fas fa-star"></i>
            ${mood.name}
        `;
          button.addEventListener('click', () => {
            document
              .querySelectorAll('.mood-button')
              .forEach((b) => b.classList.remove('active'));
            button.classList.add('active');
            currentMood = mood.name.toLowerCase();
            updatePrompt(currentMood);
          });
          container.insertBefore(button, addButton);
        });
      }

      function setupMoodButtons() {
        const buttons = document.querySelectorAll(
          '.mood-button:not(.add-mood-button)'
        );
        buttons.forEach((button) => {
          button.addEventListener('click', () => {
            buttons.forEach((b) => b.classList.remove('active'));
            button.classList.add('active');
            currentMood = button.dataset.mood;
            updatePrompt(currentMood);
          });
        });

        // Set initial active mood
        const initialMoodButton = document.querySelector(
          `.mood-button[data-mood="${currentMood}"]`
        );
        if (initialMoodButton) {
          initialMoodButton.classList.add('active');
        }
      }

      function updateCollaboratorsUI(participants) {
        const container = document.getElementById('activeWriters');
        if (!container) return;

        container.innerHTML = Object.entries(participants)
          .map(
            ([uid, user]) => `
            <div class="collaborator">
                <img src="${user.photoURL}" alt="${user.displayName}">
                <span>${user.displayName}</span>
            </div>
        `
          )
          .join('');
      }

      function updateViewersUI(viewers) {
        const container = document.getElementById('activeViewers');
        const viewerCount = document.getElementById('viewerCount');

        if (viewerCount) {
          viewerCount.textContent = Object.keys(viewers).length;
        }

        if (container) {
          container.innerHTML = Object.entries(viewers)
            .map(
              ([uid, viewer]) => `
                <div class="viewer">
                    <img src="${viewer.photoURL}" alt="${viewer.displayName}">
                    <span>${viewer.displayName}</span>
                    ${
                      viewer.isTyping
                        ? '<span class="typing-indicator">typing...</span>'
                        : ''
                    }
                </div>
            `
            )
            .join('');
        }
      }

      

      // Achievement Functions
      async function checkAchievements(contribution) {
        const userAchievementsRef = ref(
          database,
          `users/${currentUser.uid}/achievements`
        );
        const snapshot = await get(userAchievementsRef);
        const earnedAchievements = snapshot.val() || {};

        const wordCount = contribution.split(/\s+/).length;
        const hour = new Date().getHours();

        if (!earnedAchievements.firstStory) {
          await unlockAchievement('firstStory');
        }

        if (wordCount > 100 && !earnedAchievements.speedWriter) {
          await unlockAchievement('speedWriter');
        }

        if (hour >= 0 && hour < 4 && !earnedAchievements.nightOwl) {
          await unlockAchievement('nightOwl');
        }
      }

      class TimerManager {
    constructor(storyId) {
        this.storyId = storyId;
        this.timerRef = ref(database, `stories/${storyId}/timer`);
    }

    async startTimer() {
        const timestamp = Date.now();
        await set(this.timerRef, {
            startTime: timestamp,
            endTime: timestamp + 45000
        });
    }

    initializeTimerSync() {
        onValue(this.timerRef, (snapshot) => {
            const timerData = snapshot.val();
            if (timerData) {
                const remaining = Math.floor((timerData.endTime - Date.now()) / 1000);
                this.updateTimerDisplay(Math.max(0, remaining));
            }
        });
    }
}

class PhaseManager {
    constructor(storyId) {
        this.storyId = storyId;
        this.phaseRef = ref(database, `stories/${storyId}/phase`);
    }

    async setPhase(phase) {
        await set(this.phaseRef, {
            currentPhase: phase,
            timestamp: serverTimestamp()
        });
    }

    listenToPhaseChanges(callback) {
        onValue(this.phaseRef, (snapshot) => {
            const phaseData = snapshot.val();
            if (phaseData) {
                callback(phaseData.currentPhase);
            }
        });
    }
}

      async function unlockAchievement(achievementId) {
        const achievement = achievements[achievementId];
        const userAchievementsRef = ref(
          database,
          `users/${currentUser.uid}/achievements/${achievementId}`
        );

        await set(userAchievementsRef, {
          ...achievement,
          unlockedAt: Date.now(),
        });

        showAchievementNotification(achievement);
      }

      function showAchievementNotification(achievement) {
        const notification = document.createElement('div');
        notification.className =
          'achievement-notification animate__animated animate__slideInRight';
        notification.innerHTML = `
        <i class="fas ${achievement.icon}"></i>
        <div class="achievement-details">
            <h4>${achievement.title}</h4>
            <p>${achievement.description}</p>
        </div>
    `;

        document.body.appendChild(notification);
        setTimeout(() => {
          notification.classList.replace(
            'animate__slideInRight',
            'animate__slideOutRight'
          );
          setTimeout(() => notification.remove(), 1000);
        }, 3000);
      }

      // Content Management Functions
      async function loadUserCustomContent() {
        if (!currentUser) return;

        const customPromptsRef = ref(
          database,
          `users/${currentUser.uid}/customPrompts`
        );
        const customMoodsRef = ref(
          database,
          `users/${currentUser.uid}/customMoods`
        );

        onValue(customPromptsRef, (snapshot) => {
          const prompts = snapshot.val() || {};
          updateCustomPromptsUI(prompts);
        });

        onValue(customMoodsRef, (snapshot) => {
          const moods = snapshot.val() || {};
          updateCustomMoodsUI(moods);
        });
      }

      async function saveCustomPrompt() {
        const promptInput = document.getElementById('newPromptInput');
        if (!promptInput || !currentUser) return;

        const prompt = promptInput.value.trim();
        if (prompt) {
          try {
            const promptRef = ref(
              database,
              `users/${currentUser.uid}/customPrompts`
            );
            const newPromptRef = push(promptRef);
            await set(newPromptRef, {
              text: prompt,
              createdAt: Date.now(),
            });

            promptInput.value = '';
            closeModal('addPromptModal');
          } catch (error) {
            console.error('Error saving custom prompt:', error);
          }
        }
      }

      class ErrorHandler {
    static async handleError(error, context) {
        console.error(`Error in ${context}:`, error);
        
        // Store error for analytics
        await set(ref(database, `errors/${Date.now()}`), {
            error: error.message,
            context,
            userId: currentUser?.uid,
            timestamp: serverTimestamp()
        });

        // Show user-friendly error message
        const message = document.querySelector('.message');
        if (message) {
            message.innerHTML = `
                <div class="error-message">
                    <i class="fas fa-exclamation-circle"></i>
                    <span>Something went wrong. Please refresh the page.</span>
                </div>
            `;
        }

        // Attempt recovery
        if (context === 'timer') {
            storyFlowManager.restartTimer();
        } else if (context === 'phase') {
            storyFlowManager.resyncPhase();
        }
    }
}

      async function saveCustomMood() {
        const moodInput = document.getElementById('newMoodInput');
        if (!moodInput || !currentUser) return;

        const mood = moodInput.value.trim();
        if (mood) {
          try {
            const moodRef = ref(
              database,
              `users/${currentUser.uid}/customMoods`
            );
            const newMoodRef = push(moodRef);
            await set(newMoodRef, {
              name: mood,
              createdAt: Date.now(),
            });

            moodInput.value = '';
            closeModal('addMoodModal');
          } catch (error) {
            console.error('Error saving custom mood:', error);
          }
        }
      }

      // Story Management Functions
      async function leaveCurrentStory() {
        if (!currentStoryId || !currentUser) return;

        try {
          const participantRef = ref(
            database,
            `stories/${currentStoryId}/participants/${currentUser.uid}`
          );
          await remove(participantRef);
        } catch (error) {
          console.error('Error leaving story:', error);
        }
      }

      // Global Window Functions
      window.showAddPromptModal = () => {
        const modal = document.getElementById('addPromptModal');
        if (modal) modal.style.display = 'flex';
      };

      window.showAddMoodModal = () => {
        const modal = document.getElementById('addMoodModal');
        if (modal) modal.style.display = 'flex';
      };

      window.closeModal = (id) => {
        const modal = document.getElementById(id);
        if (modal) modal.style.display = 'none';
      };

      window.saveCustomPrompt = saveCustomPrompt;
      window.saveCustomMood = saveCustomMood;

      window.deleteCustomPrompt = async (id) => {
        if (!currentUser) return;
        try {
          await remove(
            ref(database, `users/${currentUser.uid}/customPrompts/${id}`)
          );
        } catch (error) {
          console.error('Error deleting prompt:', error);
        }
      };

      window.startNewStory = async () => {
        try {
          if (currentStoryId) {
            await leaveCurrentStory();
          }

          const storyFlowManager = new StoryFlowManager();
          await storyFlowManager.initialize();

          const postContribution = document.querySelector('.post-contribution');
          if (postContribution) {
            postContribution.classList.remove('show');
          }
        } catch (error) {
          console.error('Error starting new story:', error);
          alert('Error starting new story. Please try again.');
        }
      };

      window.continueCollaborating = () => {
        const postContribution = document.querySelector('.post-contribution');
        if (postContribution) {
          postContribution.classList.remove('show');
        }
        if (window.storyFlowManager) {
          window.storyFlowManager.startNewRound();
        }
      };

      window.addReaction = async (contributionId, reactionType) => {
        if (!currentUser || !currentStoryId) return;

        try {
          const reactionRef = ref(
            database,
            `stories/${currentStoryId}/contributions/${contributionId}/reactions/${reactionType}`
          );
          const snapshot = await get(reactionRef);
          const reactions = snapshot.val() || [];

          const userIndex = reactions.indexOf(currentUser.uid);

          if (userIndex > -1) {
            reactions.splice(userIndex, 1);
          } else {
            reactions.push(currentUser.uid);
            const button = document.querySelector(
              `[onclick="addReaction('${contributionId}', '${reactionType}')"]`
            );
            if (button) {
              button.classList.add('reaction-pop');
              setTimeout(() => button.classList.remove('reaction-pop'), 300);
            }
          }

          await set(reactionRef, reactions);
        } catch (error) {
          console.error('Error adding reaction:', error);
        }
      };

      // Initialize App
      async function initializeAppFeatures() {
        console.log('Initializing app features...');
        try {
          if (!currentUser) {
            throw new Error('User not authenticated');
          }

          // Test database access
          const testRef = ref(database, `users/${currentUser.uid}/test`);
          try {
            await set(testRef, { timestamp: Date.now() });
            await remove(testRef);
            console.log('Database access verified');
          } catch (error) {
            console.error('Database access error:', error);
            throw new Error('Database access denied');
          }

          // Initialize features one by one
          console.log('Loading user content...');
          await loadUserCustomContent();

          console.log('Setting up mood buttons...');
          setupMoodButtons();

          console.log('Setting up custom prompts...');
          await setupCustomPrompts();

          // Initialize UI elements
          updatePrompt(currentMood);

          // Initialize story flow manager as a global instance
          console.log('Initializing story flow manager...');
          window.storyFlowManager = new StoryFlowManager();
          await window.storyFlowManager.initialize();

          console.log('App initialization complete');
        } catch (error) {
          console.error('Error initializing app:', error);
          const message = document.querySelector('.message');
          if (message) {
            message.innerHTML = `
                <div class="error-message">
                    <i class="fas fa-exclamation-circle"></i>
                    <span>Error: ${error.message}</span>
                </div>
            `;
          }
        }
      }

      // Initialize Auth State Observer
      onAuthStateChanged(auth, (user) => {
        if (user) {
          currentUser = user;
          initializeAppFeatures();
        } else {
          window.location.href = 'index.html';
        }
      });

    </script>
  </body>
</html>
