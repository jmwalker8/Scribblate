<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scribblate - Collaborative Story Writing</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --transition-speed: 0.3s;
            /* Light theme (default) */
            --primary: #4169e1;
            --secondary: #7c3aed;
            --background: #f5f5f5;
            --white: #000;
            --text: #333333;
            --card-bg: #ffffff;
            --card-shadow: 0 2px 10px rgba(0,0,0,0.1);
            --border: #e5e7eb;
            --skeleton-base: #f0f0f0;
            --skeleton-highlight: #f8f8f8;
            --nav-bg: #ffffff;
            --header-bg: #ffffff;
        }

        [data-theme="dark"] {
            --primary: #6d8fff;
            --secondary: #9d6dff;
            --background: #1a1a1a;
            --text: #e5e5e5;
            --white: #fff;
            --card-bg: #2d2d2d;
            --card-shadow: 0 2px 10px rgba(0,0,0,0.3);
            --border: #404040;
            --skeleton-base: #2d2d2d;
            --skeleton-highlight: #3d3d3d;
            --nav-bg: #2d2d2d;
            --header-bg: #2d2d2d;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }

        body {
            background: var(--background);
            min-height: 100vh;
            color: var(--text);
            transition: background-color var(--transition-speed);
        }

        /* Navigation styles */
        .nav-bar {
            background: var(--nav-bg);
            padding: 1rem 2rem;
            box-shadow: var(--card-shadow);
            position: fixed;
            width: 100%;
            top: 0;
            z-index: 100;
            transition: background-color var(--transition-speed),
                        box-shadow var(--transition-speed);
        }

        .nav-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary);
            transition: color var(--transition-speed);
        }

        #logo-p {
            font-size: 10px;
            font-weight: 300;
            color: var(--white);
            transition: color var(--transition-speed);
        }

        .nav-buttons {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        /* Container and header styles */
        .container {
            max-width: 1200px;
            margin: 6rem auto 2rem;
            padding: 0 2rem;
        }

        .header-section {
            background: var(--header-bg);
            border-radius: 12px;
            padding: 3rem;
            text-align: center;
            margin-bottom: 2rem;
            box-shadow: var(--card-shadow);
            transition: background-color var(--transition-speed),
                        box-shadow var(--transition-speed);
        }

        .header-title {
            font-size: 2.5rem;
            color: var(--text);
            margin-bottom: 1rem;
            transition: color var(--transition-speed);
        }

        .header-subtitle {
            color: var(--secondary);
            font-size: 1.2rem;
            margin-bottom: 2rem;
            transition: color var(--transition-speed);
        }

        /* Button styles */
        .button {
            padding: 0.75rem 1.5rem;
            border-radius: 20px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            border: none;
        }

        .button-primary {
            background: var(--primary);
            color: white;
        }

        .button-secondary {
            background: var(--card-bg);
            color: var(--text);
            border: 1px solid var(--border);
        }

        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        /* Category styles */
        .categories {
            display: flex;
            gap: 1rem;
            margin: 2rem 0;
            flex-wrap: wrap;
            justify-content: center;
        }

        .category-tag {
            padding: 0.75rem 1.5rem;
            border-radius: 20px;
            background: var(--card-bg);
            color: var(--secondary);
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: var(--card-shadow);
        }

        .category-tag:hover {
            background: var(--primary);
            color: white;
        }

        .category-tag.active {
            background: var(--primary);
            color: white;
        }

        /* Story grid and card styles */
        .stories-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 2rem;
            margin-top: 2rem;
        }

        .story-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: var(--card-shadow);
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1),
                      box-shadow 0.3s ease,
                      background-color var(--transition-speed);
            opacity: 0;
            transform: translateY(20px);
        }

        .story-card.animate-in {
            animation: fadeInUp 0.6s ease forwards;
        }

        .story-card:hover {
            transform: scale(1.02) translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }

        .story-header {
    margin-bottom: 1rem;
}

.story-title {
    font-size: 1.2rem;
    color: var(--text);
    margin-bottom: 0.5rem;
}

.story-category {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    border-radius: 15px;
    font-size: 0.8rem;
    background: rgba(65, 105, 225, 0.1);
    color: var(--primary);
}

.story-content {
    color: var(--secondary);
    line-height: 1.6;
    margin-bottom: 1rem;
    flex-grow: 1;
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

        .story-stats {
            display: flex;
            gap: 1rem;
            color: var(--secondary);
            font-size: 0.9rem;
            transition: color var(--transition-speed);
        }

        .story-status {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 1rem;
    font-size: 0.9rem;
}

.status-indicator {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #22c55e;
    flex-shrink: 0;
}

        /* Section title styles */
        .section-title {
            font-size: 1.5rem;
            color: var(--text);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: color var(--transition-speed);
        }

        /* Dark mode toggle styles */
        .theme-toggle {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }

        .theme-toggle:hover {
            background: var(--border);
        }

        .theme-toggle svg {
            width: 20px;
            height: 20px;
            color: var(--text);
            transition: color var(--transition-speed);
        }

        /* Loading skeleton styles */
        .story-card-skeleton {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: var(--card-shadow);
            height: 180px;
            overflow: hidden;
            position: relative;
            transition: background-color var(--transition-speed),
                      box-shadow var(--transition-speed);
        }

        .story-card-skeleton::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(
                90deg,
                var(--skeleton-base) 0%,
                var(--skeleton-highlight) 50%,
                var(--skeleton-base) 100%
            );
            background-size: 200% 100%;
            animation: shimmer 2s infinite;
        }

        /* Queue styles */
        .writer-queue {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-bottom: 1rem;
            transition: all var(--transition-speed);
        }

        .queue-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            background: var(--card-bg);
            border-radius: 8px;
            transition: background-color var(--transition-speed);
        }

        .queue-item.you {
            background: rgba(65, 105, 225, 0.1);
        }

        .queue-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
        }

        .queue-position {
            font-weight: bold;
            color: var(--secondary);
            min-width: 30px;
        }

        .queue-name {
            flex: 1;
            color: var(--text);
        }

        .queue-you-badge {
            font-size: 0.8rem;
            padding: 0.2rem 0.5rem;
            background: var(--primary);
            color: white;
            border-radius: 12px;
        }

        .active-stories-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 2rem;
    margin-top: 2rem;
}

.active-story-card {
    background: var(--card-bg);
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: var(--card-shadow);
    transition: transform 0.2s;
    display: flex;
    flex-direction: column;
    height: 100%;
}

.active-story-card:hover {
    transform: translateY(-5px);
}

.story-status {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-top: 1rem;
    font-size: 0.9rem;
}

.status-indicator {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #22c55e;
}

.story-actions {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
    margin-top: auto;
}

.view-story-btn, 
.join-story-btn {
    padding: 0.75rem 1rem;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    font-size: 0.9rem;
    height: 40px;
}

.view-story-btn {
    background: var(--card-bg);
    color: var(--secondary);
    border: 1px solid var(--border);
}

.view-story-btn:hover {
    background: var(--border);
}

.join-story-btn {
    background: var(--primary);
    color: white;
}

.join-story-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.join-story-btn:disabled {
    background: var(--border);
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
}

.story-view-modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 2rem;
    z-index: 1000;
}

.story-view-content {
    background: white;
    border-radius: 12px;
    width: 100%;
    max-width: 800px;
    max-height: 90vh;
    display: flex;
    flex-direction: column;
}

.story-view-header {
    padding: 1.5rem;
    border-bottom: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.story-view-body {
    padding: 1.5rem;
    overflow-y: auto;
}

.modal-header h2 {
    font-size: 1.5rem;
    color: white;
}

.close-button {
    background: rgba(255, 255, 255, 0.2);
    border: none;
    color: white;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: background 0.2s;
}

.close-button:hover {
    background: rgba(255, 255, 255, 0.3);
}

.story-modal .modal-content {
        width: 90%;
        max-width: 800px;
        max-height: 90vh;
        display: flex;
        flex-direction: column;
    }

    .story-modal .modal-body {
        padding: 1.5rem;
        overflow-y: auto;
    }

    .story-contributions {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .contribution {
    background: #f8fafc;
    border-radius: 8px;
    padding: 1.5rem;
    margin-bottom: 1rem;
}

    .story-view-modal {
    padding: 2rem;
}
    

.story-view-content {
    background: white;
    border-radius: 12px;
    width: 100%;
    max-width: 800px;
    margin: 0 auto;
    overflow: hidden;
}
    

.story-view-header {
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    color: white;
    padding: 1.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.story-view-body {
    padding: 2rem;
}

.story-entry {
    background: white;
    border-radius: 8px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

.author-section {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 1rem;
}

.author-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: var(--primary);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
    font-weight: bold;
}

.author-info {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
}

.author-name {
    font-weight: 500;
    color: var(--text);
}

.timestamp {
    font-size: 0.85rem;
    color: var(--secondary);
}

.story-prompt {
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    color: white;
    padding: 1.5rem;
    border-radius: 8px;
    margin-bottom: 2rem;
    font-size: 1.2rem;
    text-align: center;
}

.close-button {
    background: none;
    border: none;
    color: var(--text);
    font-size: 1.5rem;
    cursor: pointer;
    padding: 0.5rem;
    border-radius: 50%;
    transition: background 0.2s;
}

.close-button:hover {
    background: var(--border);
}

    .contribution-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
    }

    .author-info {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .timestamp {
        color: var(--secondary);
        font-size: 0.9rem;
    }

    .contribution-content {
    font-size: 1.1rem;
    line-height: 1.6;
    color: var(--text);
    margin-top: 1rem;
}

    .content {
    color: var(--text);
    line-height: 1.6;
    font-size: 1.1rem;
    margin: 1rem 0;
}

    .error-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 1rem;
        padding: 2rem;
        text-align: center;
    }

    .error-state i {
        font-size: 2rem;
        color: #ef4444;
    }

    .retry-button {
        padding: 0.5rem 1rem;
        border: none;
        border-radius: 6px;
        background: var(--primary);
        color: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

.join-story-btn {
    width: 100%;
    margin-top: 1rem;
    padding: 0.75rem;
    border: none;
    border-radius: 8px;
    background: var(--primary);
    color: white;
    cursor: pointer;
    transition: all 0.2s;
}

.join-story-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.story-view-modal {
    background: rgba(0, 0, 0, 0.75); /* Darker overlay */
}

.story-entry {
    background: var(--card-bg);
    margin-bottom: 1.5rem;
    transition: transform 0.2s;
}

.story-entry:hover {
    transform: translateY(-2px);
}

.story-prompt {
    margin-bottom: 2rem;
    font-weight: 500;
}

.join-story-btn:disabled {
    background: var(--border);
    cursor: not-allowed;
}

        /* Animations */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes shimmer {
            0% {
                background-position: -200% 0;
            }
            100% {
                background-position: 200% 0;
            }
        }

        /* Responsive styles */
        @media (max-width: 768px) {
            .container {
                padding: 0 1rem;
            }

            .header-section {
                padding: 2rem 1rem;
            }

            .header-title {
                font-size: 2rem;
            }

            .categories {
                gap: 0.5rem;
            }

            .category-tag {
                padding: 0.5rem 1rem;
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>
    <nav class="nav-bar">
        <div class="nav-content">
            <div class="logo">Scribblate <br> <p id="logo-p">Created By Julian Walker</p></div>
            <div class="nav-buttons">
                <button class="theme-toggle" aria-label="Toggle dark mode">
                    <!-- Icon will be inserted by JavaScript -->
                </button>
                <button class="button button-secondary">Sign In</button>
                <button class="button button-primary">Start Writing</button>
            </div>
        </div>
    </nav>

    <div class="container">
        <section class="header-section">
            <h1 class="header-title">Create Stories Together</h1>
            <p class="header-subtitle">45 seconds at a time</p>
            <button class="button button-primary">
                <i class="fas fa-pen"></i>
                Start Writing
            </button>
        </section>
    
        <div class="categories">
            <div class="category-tag active">All Stories</div>
            <div class="category-tag">Creative</div>
            <div class="category-tag">Mysterious</div>
            <div class="category-tag">Adventure</div>
            <div class="category-tag">Romantic</div>
            <div class="category-tag">Sci-Fi</div>
        </div>
    
        <h2 class="section-title">
            <i class="fas fa-star"></i>
            Featured Stories
        </h2>
        
        <div class="stories-grid">
            <!-- Story cards will be inserted here by JavaScript -->
        </div>
    
        <h2 class="section-title">
            <i class="fas fa-pen-fancy"></i>
            Active Stories
        </h2>
        
        <div class="active-stories-grid">
            <!-- Active stories will be loaded here -->
        </div>
    </div>

    <script type="module">
       
       // Import Firebase modules
// Import Firebase modules
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
import { 
    getDatabase, 
    ref, 
    set, 
    onValue, 
    get, 
    remove, 
    onDisconnect,
    push,
    serverTimestamp,
    query,
    orderByChild,
    startAfter,
    endAt 
} from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js';

// Firebase configuration
const firebaseConfig = {
    apiKey: "AIzaSyD5cPsewQLJEqkzxqSGX-QZQmrK-dxpvaM",
    authDomain: "scribblate-ce00a.firebaseapp.com",
    projectId: "scribblate-ce00a",
    storageBucket: "scribblate-ce00a.firebasestorage.app",
    messagingSenderId: "752237311953",
    appId: "1:752237311953:web:5d9425779169a9b80752f0",
    measurementId: "G-B47QVGX24Y",
    databaseURL: "https://scribblate-ce00a-default-rtdb.firebaseio.com"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const database = getDatabase(app);

// Global state
let currentUser = null;

// Theme Management
class ThemeManager {
    constructor() {
        this.theme = localStorage.getItem('theme') || 'light';
        this.init();
    }

    init() {
        const themeToggle = document.querySelector('.theme-toggle');
        themeToggle.innerHTML = this.getThemeIcon();
        themeToggle.addEventListener('click', () => this.toggleTheme());
        this.applyTheme();
    }

    getThemeIcon() {
        return this.theme === 'light' 
            ? '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/></svg>'
            : '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707"/></svg>';
    }

    toggleTheme() {
        this.theme = this.theme === 'light' ? 'dark' : 'light';
        localStorage.setItem('theme', this.theme);
        this.applyTheme();
        document.querySelector('.theme-toggle').innerHTML = this.getThemeIcon();
    }

    applyTheme() {
        document.documentElement.setAttribute('data-theme', this.theme);
    }
}

// Story Management
class StoryManager {
    constructor() {
        this.storiesGrid = document.querySelector('.stories-grid');
        this.activeStoriesGrid = document.querySelector('.active-stories-grid');
        this.loadingStories = false;
    }

    createSkeletonLoader() {
        return `<div class="story-card-skeleton" aria-hidden="true"></div>`.repeat(6);
    }

    async loadStories(category = 'all') {
        if (this.loadingStories) return;
        this.loadingStories = true;

        try {
            // Show skeleton loaders
            this.storiesGrid.innerHTML = this.createSkeletonLoader();

            // Fetch stories
            const storiesRef = ref(database, 'stories');
            const snapshot = await get(storiesRef);
            const stories = [];

            if (snapshot.exists()) {
                snapshot.forEach((childSnapshot) => {
                    const story = childSnapshot.val();
                    if (story.status === 'completed' && (category === 'all' || story.category === category)) {
                        stories.push({
                            id: childSnapshot.key,
                            ...story
                        });
                    }
                });
            }

            // Clear skeleton loaders
            this.storiesGrid.innerHTML = '';
            
            // Add stories with staggered animation
            stories.forEach((story, index) => {
                setTimeout(() => {
                    const storyCard = this.createStoryCard(story);
                    storyCard.classList.add('animate-in');
                    storyCard.style.animationDelay = `${index * 100}ms`;
                    this.storiesGrid.appendChild(storyCard);
                }, index * 100);
            });
        } catch (error) {
            console.error('Error loading stories:', error);
            this.storiesGrid.innerHTML = '<p class="error-message">Error loading stories. Please try again.</p>';
        } finally {
            this.loadingStories = false;
        }
    }

    async loadActiveStories() {
        try {
            const storiesRef = ref(database, 'stories');
            const oneDayAgo = Date.now() - (24 * 60 * 60 * 1000);
            
            const storiesSnapshot = await get(storiesRef);
            
            if (!storiesSnapshot.exists()) {
                this.activeStoriesGrid.innerHTML = '<p class="no-stories">No active stories at the moment. Start writing!</p>';
                return;
            }

            const activeStories = [];
            const usedPrompts = new Set();

            // Cleanup old or empty stories first
            const cleanup = [];
            
            storiesSnapshot.forEach((childSnapshot) => {
                const story = childSnapshot.val();
                const storyId = childSnapshot.key;
                
                // Mark for cleanup if:
                // 1. Story is older than 24 hours and has no participants
                // 2. Story has no participants and no contributions
                // 3. Story was created but never got any content
                if ((story.createdAt < oneDayAgo && (!story.participants || Object.keys(story.participants).length === 0)) ||
                    (!story.participants && !story.contributions) ||
                    (story.createdAt < Date.now() - (30 * 60 * 1000) && !story.contributions)) {
                    cleanup.push(remove(ref(database, `stories/${storyId}`)));
                    return;
                }

                // Only include valid active stories
                if (this.isValidActiveStory(story)) {
                    const prompt = story.prompt || '';
                    if (!usedPrompts.has(prompt)) {
                        usedPrompts.add(prompt);
                        activeStories.push({
                            id: storyId,
                            ...story
                        });
                    }
                }
            });

            // Perform cleanup if needed
            if (cleanup.length > 0) {
                await Promise.all(cleanup);
            }

            this.activeStoriesGrid.innerHTML = activeStories.map(story => this.createActiveStoryCard(story)).join('');
        } catch (error) {
            console.error('Error loading active stories:', error);
            this.activeStoriesGrid.innerHTML = '<p class="error-message">Error loading active stories. Please try again.</p>';
        }
    }

    isValidActiveStory(story) {
        const hasParticipants = story.participants && Object.keys(story.participants).length > 0;
        const hasContributions = story.contributions && Object.keys(story.contributions).length > 0;
        const isRecent = story.createdAt > Date.now() - (24 * 60 * 60 * 1000);
        
        // Story is valid if:
        // 1. It's recent and has participants, or
        // 2. It has actual contributions
        return (isRecent && hasParticipants) || hasContributions;
    }

// In the StoryManager class
createActiveStoryCard(story) {
        const participantCount = Object.keys(story.participants || {}).length;
        const hasContributions = story.contributions && Object.keys(story.contributions).length > 0;
        const title = this.generateTitleFromPrompt(story.prompt) || 'Untitled Story';
        
        return `
            <div class="active-story-card">
                <div class="story-header">
                    <h3 class="story-title">${title}</h3>
                    <span class="story-category">${story.category || story.currentMood || 'Creative'}</span>
                </div>
                <p class="story-content">
                    ${hasContributions ? this.getStoryPreview(story.contributions) : story.prompt || 'A new story is beginning...'}
                </p>
                <div class="story-status">
                    <span class="status-indicator"></span>
                    <span>${participantCount}/5 writers</span>
                    <span>â€¢</span>
                    <span>${this.getTimeAgo(story.createdAt)}</span>
                </div>
                <div class="story-actions">
                    ${hasContributions ? `
                        <button class="view-story-btn" onclick="viewStory('${story.id}')">
                            <i class="fas fa-eye"></i> View Story
                        </button>
                    ` : ''}
                    <button 
                        class="join-story-btn"
                        onclick="window.joinStory('${story.id}')"
                        ${participantCount >= 5 ? 'disabled' : ''}
                    >
                        ${participantCount >= 5 ? 'Story Full' : 'Join Story'}
                    </button>
                </div>
            </div>
        `;
    }

generateTitleFromPrompt(prompt) {
    if (!prompt) return null;
    
    // Remove common starter phrases
    const cleanPrompt = prompt
        .replace(/^In a world where/i, '')
        .replace(/^When/i, '')
        .replace(/^The/i, '')
        .replace(/^Through/i, '')
        .replace(/^Their/i, '');

    // Get first meaningful segment
    const segments = cleanPrompt.split(/[,.;]/);
    let title = segments[0].trim();

    // Capitalize first letter of each word
    title = title.split(' ')
        .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
        .join(' ');

    // Limit length
    if (title.length > 50) {
        title = title.substring(0, 47) + '...';
    }

    return title || 'Untitled Story';
}

    createStoryCard(story) {
        const card = document.createElement('div');
        card.className = 'story-card';
        card.innerHTML = `
            <div class="story-header">
                <h3 class="story-title">${story.title || 'Untitled Story'}</h3>
                <span class="story-category">${story.category || 'Uncategorized'}</span>
            </div>
            <p class="story-content">${this.getStoryPreview(story.contributions)}</p>
            <div class="story-stats">
                <span><i class="fas fa-user"></i> ${Object.keys(story.participants || {}).length} writers</span>
                <span><i class="fas fa-heart"></i> ${Object.keys(story.likes || {}).length} likes</span>
                <span><i class="fas fa-clock"></i> ${this.getTimeAgo(story.createdAt)}</span>
            </div>
        `;
        return card;
    }

    getStoryPreview(contributions = {}) {
    if (!contributions || Object.keys(contributions).length === 0) return '';
    
    // Sort contributions by timestamp and get the first one
    const sortedContributions = Object.values(contributions)
        .sort((a, b) => a.timestamp - b.timestamp);
    
    const firstContribution = sortedContributions[0]?.content || '';
    return firstContribution.length > 150 ? 
        firstContribution.slice(0, 147) + '...' : 
        firstContribution;
}

    getTimeAgo(timestamp) {
        if (!timestamp) return 'just now';
        const seconds = Math.floor((Date.now() - timestamp) / 1000);
        
        const intervals = {
            year: 31536000,
            month: 2592000,
            week: 604800,
            day: 86400,
            hour: 3600,
            minute: 60,
            second: 1
        };

        for (const [unit, secondsInUnit] of Object.entries(intervals)) {
            const interval = Math.floor(seconds / secondsInUnit);
            if (interval >= 1) {
                return interval === 1 ? `1 ${unit} ago` : `${interval} ${unit}s ago`;
            }
        }
        return 'just now';
    }
}

// Add to window object
window.viewStory = async (storyId) => {
    if (!currentUser) {
        window.location.href = 'index.html';
        return;
    }

    const modal = document.createElement('div');
    modal.className = 'story-view-modal';
    modal.innerHTML = `
        <div class="story-view-content">
            <div class="story-view-header">
                <h2>Loading story...</h2>
                <button class="close-button" onclick="this.closest('.story-view-modal').remove()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="story-view-body">
                <div id="story-content">
                    <div class="loading-spinner">
                        <i class="fas fa-circle-notch fa-spin"></i>
                        Loading...
                    </div>
                </div>
            </div>
        </div>
    `;

    document.body.appendChild(modal);

    try {
        const storyRef = ref(database, `stories/${storyId}`);
        const snapshot = await get(storyRef);
        const story = snapshot.val();

        if (!story) {
            throw new Error('Story not found');
        }

        // Update header
        const header = modal.querySelector('.story-view-header h2');
        header.textContent = story.prompt || 'Untitled Story';

        // Update content
        const contentDiv = modal.querySelector('#story-content');
        
        // Add prompt
        contentDiv.innerHTML = `
            <div class="story-prompt">${story.prompt || ''}</div>
            <div class="story-entries"></div>
        `;

        // Set up real-time listener for contributions
        const contributionsRef = ref(database, `stories/${storyId}/contributions`);
        onValue(contributionsRef, (snapshot) => {
            const contributions = snapshot.val() || {};
            const entriesDiv = modal.querySelector('.story-entries');

            const sortedContributions = Object.entries(contributions)
                .sort(([, a], [, b]) => a.timestamp - b.timestamp);

            entriesDiv.innerHTML = sortedContributions.length > 0 ? 
                sortedContributions.map(([id, contribution]) => `
                    <div class="story-entry">
                        <div class="author-section">
                            <div class="author-avatar">
                                ${contribution.userPhoto ? 
                                    `<img src="${contribution.userPhoto}" alt="">` : 
                                    contribution.userName.charAt(0)}
                            </div>
                            <div class="author-info">
                                <span class="author-name">${contribution.userName}</span>
                                <span class="timestamp">${formatTimeAgo(contribution.timestamp)}</span>
                            </div>
                        </div>
                        <div class="content">${contribution.content}</div>
                    </div>
                `).join('') : 
                '<div class="no-contributions">No contributions yet</div>';
        });

    } catch (error) {
        console.error('Error loading story:', error);
        modal.querySelector('#story-content').innerHTML = `
            <div class="error-state">
                <i class="fas fa-exclamation-circle"></i>
                <p>Failed to load story</p>
                <button onclick="viewStory('${storyId}')">Retry</button>
            </div>
        `;
    }
};

window.react = async (contributionId, reactionType) => {
    if (!currentUser) return;

    try {
        const reactionRef = ref(database, `stories/${currentStoryId}/contributions/${contributionId}/reactions/${reactionType}`);
        const snapshot = await get(reactionRef);
        const reactions = snapshot.val() || [];
        
        const userIndex = reactions.indexOf(currentUser.uid);
        if (userIndex > -1) {
            reactions.splice(userIndex, 1);
        } else {
            reactions.push(currentUser.uid);
        }
        
        await set(reactionRef, reactions);
    } catch (error) {
        console.error('Error adding reaction:', error);
    }
};

function formatTimeAgo(timestamp) {
    const seconds = Math.floor((Date.now() - (timestamp?.toMillis?.() || timestamp)) / 1000);
    
    if (seconds < 60) return 'just now';
    if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
    if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
    if (seconds < 604800) return `${Math.floor(seconds / 86400)}d ago`;
    
    return new Date(timestamp).toLocaleDateString();
}


// Landing Page Handler
class LandingPageHandler {
    constructor() {
        this.initializeButtons();
    }

    initializeButtons() {
        const startWritingButtons = document.querySelectorAll('.button-primary');
        startWritingButtons.forEach(button => {
            button.addEventListener('click', () => this.handleStartWriting());
        });
    }

    async handleStartWriting() {
        try {
            if (!currentUser) {
                window.location.href = 'index.html';
                return;
            }

            const storySession = await this.createOrJoinStorySession(currentUser.uid);
            localStorage.setItem('currentStoryId', storySession.id);
            window.location.href = 'write.html';
        } catch (error) {
            console.error('Error starting writing session:', error);
            alert('Unable to start writing session. Please try again.');
        }
    }

    async createOrJoinStorySession(userId) {
        const activeStoriesRef = ref(database, 'activeStories');
        const snapshot = await get(activeStoriesRef);
        
        if (snapshot.exists()) {
            const activeStories = snapshot.val();
            for (const [storyId, story] of Object.entries(activeStories)) {
                if (story.participantCount < 5) {
                    await set(ref(database, `stories/${storyId}/participants/${userId}`), {
                        joinedAt: serverTimestamp(),
                        lastActive: serverTimestamp()
                    });

                    await set(ref(database, `activeStories/${storyId}/participantCount`), story.participantCount + 1);

                    return { id: storyId, ...story };
                }
            }
        }

        return await this.createNewStorySession(userId);
    }

    async createNewStorySession(userId) {
    const storiesRef = ref(database, 'stories');
    const newStoryRef = push(storiesRef);

    // Get a random prompt
    const moods = ['creative', 'mysterious', 'adventure', 'romantic', 'sci-fi'];
    const randomMood = moods[Math.floor(Math.random() * moods.length)];
    const prompts = defaultPrompts[randomMood];
    const randomPrompt = prompts[Math.floor(Math.random() * prompts.length)];

    const storyData = {
        createdAt: serverTimestamp(),
        status: 'active',
        currentPhase: 'brainstorm',
        prompt: randomPrompt, // Add the prompt here
        participants: {
            [userId]: {
                joinedAt: serverTimestamp(),
                lastActive: serverTimestamp()
            }
        },
        contributions: {},
        settings: {
            maxParticipants: 5,
            timePerContribution: 45,
            mood: randomMood
        }
    };

    await set(newStoryRef, storyData);
    await set(ref(database, `activeStories/${newStoryRef.key}`), {
        createdAt: serverTimestamp(),
        participantCount: 1
    });

    return { id: newStoryRef.key, ...storyData };
}
}

// Initialize global join story function
window.joinStory = async (storyId) => {
    if (!currentUser) {
        window.location.href = 'app.html';
        return;
    }

    try {
        const storyRef = ref(database, `stories/${storyId}`);
        const story = (await get(storyRef)).val();

        if (!story || story.status !== 'active') {
            alert('This story is no longer available.');
            return;
        }

        if (Object.keys(story.participants || {}).length >= 5) {
            alert('This story is full.');
            return;
        }

        // Add user to participants
        await set(ref(database, `stories/${storyId}/participants/${currentUser.uid}`), {
            joinedAt: serverTimestamp(),
            displayName: currentUser.displayName,
            photoURL: currentUser.photoURL
        });

        // Store story ID and set join flag
        localStorage.setItem('storyId', storyId);
        localStorage.setItem('isNewStory', 'false');

        // Redirect to writing page
        window.location.href = 'write.html';
    } catch (error) {
        console.error('Error joining story:', error);
        alert('Unable to join story. Please try again.');
    }
};

// Initialize everything when DOM is loaded
document.addEventListener('DOMContentLoaded', () => {
    const themeManager = new ThemeManager();
    const storyManager = new StoryManager();
    const landingPageHandler = new LandingPageHandler();

    // Load initial stories
    storyManager.loadStories();
    storyManager.loadActiveStories();

    // Set up category filters
    const categoryTags = document.querySelectorAll('.category-tag');
    categoryTags.forEach(tag => {
        tag.addEventListener('click', (e) => {
            categoryTags.forEach(t => t.classList.remove('active'));
            e.target.classList.add('active');
            const category = e.target.textContent.toLowerCase();
            storyManager.loadStories(category);
        });
    });

    // Auto-refresh active stories
    setInterval(() => storyManager.loadActiveStories(), 30000);

    // Initialize auth state listener
    // Initialize auth state listener
onAuthStateChanged(auth, (user) => {
    currentUser = user;
    const signInButton = document.querySelector('.button-secondary');
    
    if (user) {
        console.log('User signed in:', user.uid);
        signInButton.textContent = 'Sign Out';
        signInButton.addEventListener('click', () => auth.signOut());

        // Reload stories after sign in
        storyManager.loadStories();
        storyManager.loadActiveStories();
    } else {
        console.log('User signed out');
        signInButton.textContent = 'Sign In';
        signInButton.addEventListener('click', () => window.location.href = 'index.html');
    }
});

// Error Handler
window.addEventListener('error', (event) => {
    console.error('Global error:', event.error);
    // Optionally log to Firebase or show user-friendly error
});

// Handle unhandled promise rejections
window.addEventListener('unhandledrejection', (event) => {
    console.error('Unhandled promise rejection:', event.reason);
    // Optionally log to Firebase or show user-friendly error
});
});
        
    </script>
</body>
</html>